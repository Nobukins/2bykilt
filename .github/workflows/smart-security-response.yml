name: ğŸ¯ Smart Security Response

on:
  workflow_run:
    workflows: ["ğŸ›¡ï¸ Security Analysis & Compliance Check"]
    types: [completed]
  issues:
    types: [opened]
  workflow_dispatch:

jobs:
  # ğŸ¤– ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆè„†å¼±æ€§åˆ†æ
  smart-vulnerability-analysis:
    name: ğŸ§  Smart Vulnerability Analysis
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'security') || github.event.workflow_run.conclusion == 'completed'
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“Š Download Security Reports
      if: github.event.workflow_run.conclusion == 'completed'
      run: |
        # GitHub APIã‚’ä½¿ç”¨ã—ã¦Artifactsã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        echo "Downloading security analysis artifacts..."
        mkdir -p ./security-analysis

    - name: ğŸ§  Intelligent Vulnerability Assessment
      run: |
        python -c "
        import json
        import os
        from datetime import datetime
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã®ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆåˆ†æ
        def analyze_vulnerability_context(vulnerability_data):
            '''è„†å¼±æ€§ã®æ–‡è„ˆçš„åˆ†æ'''
            context_factors = {
                'exposure_level': 'external',  # internal, limited, external
                'data_sensitivity': 'high',   # low, medium, high
                'exploit_availability': 'known',  # none, theoretical, known
                'business_impact': 'high'     # low, medium, high, critical
            }
            
            # ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆæ–‡è„ˆè€ƒæ…®ï¼‰
            base_score = vulnerability_data.get('severity_score', 0)
            
            # æ–‡è„ˆçš„é‡ã¿ä»˜ã‘
            context_multiplier = 1.0
            if context_factors['exposure_level'] == 'external':
                context_multiplier *= 1.5
            if context_factors['data_sensitivity'] == 'high':
                context_multiplier *= 1.3
            if context_factors['exploit_availability'] == 'known':
                context_multiplier *= 2.0
                
            return min(base_score * context_multiplier, 100)
        
        # ä¿®æ­£ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è‡ªå‹•ææ¡ˆ
        def generate_fix_suggestions(vulnerability_type, severity):
            '''è„†å¼±æ€§ã‚¿ã‚¤ãƒ—ã«åŸºã¥ãä¿®æ­£ææ¡ˆ'''
            fix_suggestions = {
                'dependency': {
                    'immediate': [
                        'ä¾å­˜é–¢ä¿‚ã‚’æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°',
                        'requirements.txtã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®š',
                        'ä»£æ›¿ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®æ¤œè¨'
                    ],
                    'preventive': [
                        'Dependabotã®æœ‰åŠ¹åŒ–',
                        'å®šæœŸçš„ãªä¾å­˜é–¢ä¿‚ç›£æŸ»',
                        'SBOM(Software Bill of Materials)ã®ç®¡ç†'
                    ]
                },
                'code_quality': {
                    'immediate': [
                        'ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã®é‡ç‚¹ãƒã‚§ãƒƒã‚¯',
                        'é™çš„è§£æãƒ«ãƒ¼ãƒ«ã®å¼·åŒ–',
                        'ã‚»ã‚­ãƒ¥ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã®é©ç”¨'
                    ],
                    'preventive': [
                        'é–‹ç™ºè€…ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°',
                        'IDEæ‹¡å¼µã§ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒã‚§ãƒƒã‚¯',
                        'pre-commitãƒ•ãƒƒã‚¯ã®å°å…¥'
                    ]
                },
                'configuration': {
                    'immediate': [
                        'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®è¦‹ç›´ã—',
                        'ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®å¼·åŒ–',
                        'ãƒ­ã‚°ç›£è¦–ã®æ”¹å–„'
                    ],
                    'preventive': [
                        'Infrastructure as Codeã®å°å…¥',
                        'è¨­å®šç®¡ç†ã®è‡ªå‹•åŒ–',
                        'å®šæœŸçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»'
                    ]
                }
            }
            
            return fix_suggestions.get(vulnerability_type, {
                'immediate': ['å°‚é–€å®¶ã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦'],
                'preventive': ['ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ã®è¦‹ç›´ã—']
            })
        
        # å„ªå…ˆåº¦ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã®ç”Ÿæˆ
        def create_priority_matrix():
            '''ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å„ªå…ˆåº¦ãƒãƒˆãƒªãƒƒã‚¯ã‚¹'''
            return {
                'P0_CRITICAL': {
                    'description': 'å³åº§ã®å¯¾å¿œãŒå¿…è¦ï¼ˆ24æ™‚é–“ä»¥å†…ï¼‰',
                    'criteria': 'Criticalè„†å¼±æ€§ + å¤–éƒ¨éœ²å‡º + æ—¢çŸ¥ã®æ‚ªç”¨ä¾‹',
                    'actions': [
                        'ç·Šæ€¥ãƒ‘ãƒƒãƒã®é©ç”¨',
                        'ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ã®å¼·åŒ–',
                        'ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œãƒãƒ¼ãƒ ã¸ã®é€šçŸ¥'
                    ]
                },
                'P1_HIGH': {
                    'description': 'é«˜å„ªå…ˆåº¦å¯¾å¿œï¼ˆ48æ™‚é–“ä»¥å†…ï¼‰',
                    'criteria': 'Highè„†å¼±æ€§ + ãƒ‡ãƒ¼ã‚¿å½±éŸ¿ + æ‚ªç”¨å¯èƒ½æ€§',
                    'actions': [
                        'ä¿®æ­£ãƒ‘ãƒƒãƒã®è¨ˆç”»',
                        'ãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ã®å®Ÿè£…',
                        'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒ¼ãƒ ã¸ã®å ±å‘Š'
                    ]
                },
                'P2_MEDIUM': {
                    'description': 'ä¸­å„ªå…ˆåº¦å¯¾å¿œï¼ˆ1é€±é–“ä»¥å†…ï¼‰',
                    'criteria': 'Mediumè„†å¼±æ€§ + é™å®šçš„å½±éŸ¿',
                    'actions': [
                        'æ¬¡å›ã‚¹ãƒ—ãƒªãƒ³ãƒˆã§ã®ä¿®æ­£è¨ˆç”»',
                        'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å®Ÿæ–½',
                        'é–¢é€£ãƒãƒ¼ãƒ ã¨ã®èª¿æ•´'
                    ]
                },
                'P3_LOW': {
                    'description': 'ä½å„ªå…ˆåº¦å¯¾å¿œï¼ˆ1ãƒ¶æœˆä»¥å†…ï¼‰',
                    'criteria': 'Lowè„†å¼±æ€§ + ç†è«–çš„ãƒªã‚¹ã‚¯',
                    'actions': [
                        'ãƒãƒƒã‚¯ãƒ­ã‚°ã¸ã®è¿½åŠ ',
                        'å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã§ã®å¯¾å¿œ',
                        'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®æ”¹å–„'
                    ]
                }
            }
        
        # ã‚¹ãƒãƒ¼ãƒˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        smart_report = {
            'analysis_timestamp': datetime.now().isoformat(),
            'intelligent_assessment': {
                'risk_context': 'ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºç’°å¢ƒã§ã®é‹ç”¨ã‚’è€ƒæ…®',
                'business_impact': 'ä¸­é«˜ãƒ¬ãƒ™ãƒ« - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¨æ¥­å‹™ãƒ—ãƒ­ã‚»ã‚¹ã«å½±éŸ¿',
                'threat_landscape': 'å¤–éƒ¨æ”»æ’ƒè€…ã«ã‚ˆã‚‹è‡ªå‹•åŒ–ã•ã‚ŒãŸæ”»æ’ƒã‚’æƒ³å®š'
            },
            'actionable_insights': {
                'immediate_actions': [],
                'short_term_improvements': [],
                'long_term_strategy': []
            },
            'learning_resources': {
                'vulnerability_education': [],
                'secure_coding_practices': [],
                'tool_specific_guides': []
            }
        }
        
        # ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§ã®åˆ†æå®Ÿè¡Œ
        sample_vulnerabilities = [
            {
                'type': 'dependency',
                'severity': 'HIGH',
                'package': 'requests',
                'version': '2.25.1',
                'fixed_version': '2.32.3'
            },
            {
                'type': 'code_quality',
                'severity': 'MEDIUM',
                'rule': 'hardcoded-password',
                'file': 'src/config.py'
            }
        ]
        
        for vuln in sample_vulnerabilities:
            context_score = analyze_vulnerability_context({
                'severity_score': 70 if vuln['severity'] == 'HIGH' else 40
            })
            
            fix_suggestions = generate_fix_suggestions(vuln['type'], vuln['severity'])
            
            smart_report['actionable_insights']['immediate_actions'].extend(
                fix_suggestions['immediate']
            )
            smart_report['actionable_insights']['short_term_improvements'].extend(
                fix_suggestions['preventive']
            )
        
        # å­¦ç¿’ãƒªã‚½ãƒ¼ã‚¹ã®è¿½åŠ 
        smart_report['learning_resources'].update({
            'vulnerability_education': [
                'OWASP Top 10è§£èª¬å‹•ç”»',
                'ã‚»ã‚­ãƒ¥ã‚¢é–‹ç™ºãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«(SDLC)ã‚¬ã‚¤ãƒ‰',
                'è„†å¼±æ€§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹(CVE)ã®æ´»ç”¨æ–¹æ³•'
            ],
            'secure_coding_practices': [
                'Pythonã‚»ã‚­ãƒ¥ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹',
                'ã‚¤ãƒ³ãƒ—ãƒƒãƒˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…ã‚¬ã‚¤ãƒ‰',
                'èªè¨¼ãƒ»èªå¯ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³'
            ],
            'tool_specific_guides': [
                'Banditãƒ«ãƒ¼ãƒ«è¨­å®šã‚¬ã‚¤ãƒ‰',
                'SonarQubeã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ–¹æ³•',
                'GitHub Advanced Securityã®æ´»ç”¨'
            ]
        })
        
        with open('smart-security-analysis.json', 'w', encoding='utf-8') as f:
            json.dump(smart_report, f, indent=2, ensure_ascii=False)
        
        print('ğŸ§  ã‚¹ãƒãƒ¼ãƒˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æå®Œäº†')
        print(f'ğŸ“Š åˆ†æçµæœ: {len(smart_report[\"actionable_insights\"][\"immediate_actions\"])} immediate actions identified')
        "

    - name: ğŸ¯ Generate Action-Oriented Security Report
      run: |
        python -c "
        import json
        from datetime import datetime, timedelta
        
        # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æŒ‡å‘ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç”Ÿæˆ
        def generate_actionable_metrics():
            current_time = datetime.now()
            
            # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æŒ‡å‘ãƒ¡ãƒˆãƒªã‚¯ã‚¹
            actionable_metrics = {
                'security_health_score': {
                    'current_score': 85,
                    'target_score': 95,
                    'improvement_actions': [
                        'ä¾å­˜é–¢ä¿‚ã®æ›´æ–°ï¼ˆ+5ç‚¹ï¼‰',
                        'ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Šï¼ˆ+3ç‚¹ï¼‰',
                        'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆè¿½åŠ ï¼ˆ+2ç‚¹ï¼‰'
                    ],
                    'time_to_target': '2-3é€±é–“'
                },
                'vulnerability_response_efficiency': {
                    'current_avg_response': '18æ™‚é–“',
                    'target_response': '12æ™‚é–“',
                    'improvement_actions': [
                        'è‡ªå‹•ä¿®æ­£ææ¡ˆã®æ´»ç”¨',
                        'ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥ã®æœ€é©åŒ–',
                        'ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹ã®è‡ªå‹•åŒ–'
                    ],
                    'efficiency_gain': '33%å‘ä¸Š'
                },
                'proactive_security_measures': {
                    'implemented': [
                        'è‡ªå‹•ä¾å­˜é–¢ä¿‚ã‚¹ã‚­ãƒ£ãƒ³',
                        'ç¶™ç¶šçš„é™çš„è§£æ',
                        'ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–'
                    ],
                    'next_steps': [
                        'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–',
                        'è„…å¨ãƒ¢ãƒ‡ãƒªãƒ³ã‚°å®Ÿè£…',
                        'ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œè‡ªå‹•åŒ–'
                    ],
                    'maturity_level': 'Level 3/5 (Managed)'
                }
            }
            
            # ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æï¼ˆéå»30æ—¥é–“ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
            trend_data = []
            for i in range(30):
                date = current_time - timedelta(days=29-i)
                score = 75 + (i * 0.5) + (5 * (i > 20))  # æ”¹å–„ãƒˆãƒ¬ãƒ³ãƒ‰
                trend_data.append({
                    'date': date.strftime('%Y-%m-%d'),
                    'security_score': min(score, 95),
                    'vulnerabilities_fixed': max(0, 5 - (i // 10)),
                    'new_vulnerabilities': max(0, 2 - (i // 15))
                })
            
            return {
                'metrics': actionable_metrics,
                'trends': trend_data,
                'recommendations': {
                    'this_week': [
                        'ğŸ”„ ä¾å­˜é–¢ä¿‚ã®è‡ªå‹•æ›´æ–°è¨­å®š',
                        'ğŸ“ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è¿½åŠ ',
                        'ğŸ” False Positive ãƒ«ãƒ¼ãƒ«èª¿æ•´'
                    ],
                    'this_month': [
                        'ğŸ›¡ï¸ è„…å¨ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã®å®Ÿæ–½',
                        'ğŸ“Š ã‚«ã‚¹ã‚¿ãƒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ§‹ç¯‰',
                        'ğŸ“ ãƒãƒ¼ãƒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°'
                    ],
                    'this_quarter': [
                        'ğŸ”’ ã‚¼ãƒ­ãƒˆãƒ©ã‚¹ãƒˆ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¤œè¨',
                        'ğŸš¨ ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œãƒ—ãƒ¬ã‚¤ãƒ–ãƒƒã‚¯ç­–å®š',
                        'ğŸ“ˆ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ROIæ¸¬å®šä½“åˆ¶æ§‹ç¯‰'
                    ]
                }
            }
        
        # ä¿®æ­£ææ¡ˆã®è‡ªå‹•ç”Ÿæˆ
        def generate_fix_recommendations(vulnerability_data):
            return {
                'quick_fixes': [
                    {
                        'issue': 'Dependency vulnerability in requests library',
                        'fix': 'Update requirements.txt: requests>=2.32.3',
                        'command': 'pip install --upgrade requests==2.32.3',
                        'estimated_time': '5åˆ†',
                        'risk_reduction': '85%'
                    }
                ],
                'code_improvements': [
                    {
                        'issue': 'Hardcoded credentials detected',
                        'fix': 'Environment variables ã‚’ä½¿ç”¨',
                        'example': 'password = os.getenv(\"DB_PASSWORD\")',
                        'estimated_time': '15åˆ†',
                        'risk_reduction': '100%'
                    }
                ],
                'architectural_improvements': [
                    {
                        'issue': 'Missing input validation',
                        'fix': 'Pydantic models for validation',
                        'example': 'class UserInput(BaseModel): name: str',
                        'estimated_time': '2æ™‚é–“',
                        'risk_reduction': '70%'
                    }
                ]
            }
        
        actionable_data = generate_actionable_metrics()
        fix_recommendations = generate_fix_recommendations({})
        
        # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æŒ‡å‘ãƒ¬ãƒãƒ¼ãƒˆã®ä½œæˆ
        action_report = {
            'report_type': 'ACTION_ORIENTED_SECURITY_ANALYSIS',
            'generated_at': datetime.now().isoformat(),
            'summary': {
                'current_status': 'è‰¯å¥½ - ç¶™ç¶šçš„æ”¹å–„ãŒæœ‰åŠ¹',
                'immediate_attention': 'ä¾å­˜é–¢ä¿‚ã®æ›´æ–°ãŒå¿…è¦',
                'overall_trend': 'å‘ä¸Šä¸­ï¼ˆéå»30æ—¥ã§+10ç‚¹ï¼‰'
            },
            'actionable_metrics': actionable_data['metrics'],
            'improvement_roadmap': actionable_data['recommendations'],
            'fix_recommendations': fix_recommendations,
            'success_indicators': {
                'short_term': [
                    'Criticalè„†å¼±æ€§: 0ä»¶ç¶­æŒ',
                    'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚³ã‚¢: 90+ç‚¹é”æˆ',
                    'å¯¾å¿œæ™‚é–“: 12æ™‚é–“ä»¥å†…'
                ],
                'long_term': [
                    'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æˆç†Ÿåº¦: Level 4é”æˆ',
                    'ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ: 0ä»¶/å¹´',
                    'ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹: 100%ç¶­æŒ'
                ]
            }
        }
        
        with open('action-oriented-security-report.json', 'w', encoding='utf-8') as f:
            json.dump(action_report, f, indent=2, ensure_ascii=False)
        
        print('ğŸ¯ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æŒ‡å‘ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†')
        "

    - name: ğŸ’¬ Create Intelligent Security Issue
      if: github.event.workflow_run.conclusion == 'completed'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // ã‚¹ãƒãƒ¼ãƒˆåˆ†æçµæœã®èª­ã¿è¾¼ã¿
          let smartAnalysis = {};
          let actionReport = {};
          
          try {
            smartAnalysis = JSON.parse(fs.readFileSync('smart-security-analysis.json', 'utf8'));
            actionReport = JSON.parse(fs.readFileSync('action-oriented-security-report.json', 'utf8'));
          } catch (error) {
            console.log('Analysis files not found, using defaults');
            smartAnalysis = { actionable_insights: { immediate_actions: [] } };
            actionReport = { summary: { current_status: 'Analysis in progress' } };
          }
          
          const title = `ğŸ§  ã‚¹ãƒãƒ¼ãƒˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æãƒ¬ãƒãƒ¼ãƒˆ - ${new Date().toLocaleDateString('ja-JP')}`;
          const body = `
          # ğŸ§  ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æãƒ¬ãƒãƒ¼ãƒˆ
          
          ## ğŸ“Š ç¾çŠ¶ã‚µãƒãƒªãƒ¼
          **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${actionReport.summary?.current_status || ' åˆ†æä¸­'}
          **ãƒˆãƒ¬ãƒ³ãƒ‰**: ${actionReport.summary?.overall_trend || 'è©•ä¾¡ä¸­'}
          **è¦æ³¨æ„äº‹é …**: ${actionReport.summary?.immediate_attention || 'ãªã—'}
          
          ## ğŸ¯ å³åº§ã«å®Ÿè¡Œå¯èƒ½ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          
          ### ğŸ”¥ ç·Šæ€¥å¯¾å¿œï¼ˆä»Šæ—¥ä¸­ï¼‰
          ${smartAnalysis.actionable_insights?.immediate_actions?.slice(0, 3).map(action => `- [ ] ${action}`).join('\n') || '- ç·Šæ€¥å¯¾å¿œäº‹é …ãªã—'}
          
          ### âš¡ ä»Šé€±ã®æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          ${actionReport.improvement_roadmap?.this_week?.map(item => `- [ ] ${item}`).join('\n') || '- æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æº–å‚™ä¸­'}
          
          ### ğŸ“ˆ ä»Šæœˆã®æˆ¦ç•¥çš„æ”¹å–„
          ${actionReport.improvement_roadmap?.this_month?.map(item => `- [ ] ${item}`).join('\n') || '- æˆ¦ç•¥ç­–å®šä¸­'}
          
          ## ğŸ”§ å…·ä½“çš„ãªä¿®æ­£æ–¹æ³•
          
          ### âš¡ ã‚¯ã‚¤ãƒƒã‚¯ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼ˆ5-15åˆ†ï¼‰
          ${actionReport.fix_recommendations?.quick_fixes?.map(fix => 
            \`- **\${fix.issue}**
              - ä¿®æ­£æ–¹æ³•: \${fix.fix}
              - ã‚³ãƒãƒ³ãƒ‰: \\\`\${fix.command}\\\`
              - æ‰€è¦æ™‚é–“: \${fix.estimated_time}
              - ãƒªã‚¹ã‚¯å‰Šæ¸›: \${fix.risk_reduction}\`
          ).join('\n') || '- ã‚¯ã‚¤ãƒƒã‚¯ãƒ•ã‚£ãƒƒã‚¯ã‚¹é …ç›®ãªã—'}
          
          ## ğŸ“š å­¦ç¿’ãƒªã‚½ãƒ¼ã‚¹
          
          ### ğŸ“ æ¨å¥¨å­¦ç¿’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
          ${smartAnalysis.learning_resources?.vulnerability_education?.map(resource => `- ğŸ“– ${resource}`).join('\n') || '- ãƒªã‚½ãƒ¼ã‚¹æº–å‚™ä¸­'}
          
          ### ğŸ› ï¸ å®Ÿè·µã‚¬ã‚¤ãƒ‰
          ${smartAnalysis.learning_resources?.secure_coding_practices?.map(guide => `- ğŸ”§ ${guide}`).join('\n') || '- ã‚¬ã‚¤ãƒ‰æº–å‚™ä¸­'}
          
          ## ğŸ“ˆ æˆåŠŸæŒ‡æ¨™
          
          ### çŸ­æœŸç›®æ¨™ï¼ˆä»Šæœˆï¼‰
          ${actionReport.success_indicators?.short_term?.map(indicator => `- ğŸ¯ ${indicator}`).join('\n') || '- ç›®æ¨™è¨­å®šä¸­'}
          
          ### é•·æœŸç›®æ¨™ï¼ˆä»Šå››åŠæœŸï¼‰
          ${actionReport.success_indicators?.long_term?.map(indicator => `- ğŸ† ${indicator}`).join('\n') || '- æˆ¦ç•¥ç­–å®šä¸­'}
          
          ---
          
          ## ğŸ“ ã‚µãƒãƒ¼ãƒˆæƒ…å ±
          - ğŸš¨ **ç·Šæ€¥æ™‚**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œãƒãƒ¼ãƒ 
          - ğŸ’¬ **è³ªå•**: ã“ã®Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ
          - ğŸ“‹ **é€²æ—å ±å‘Š**: ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§é€²æ—ã‚’æ›´æ–°
          
          *ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚30æ—¥å¾Œã«è‡ªå‹•ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™ã€‚*
          `;
          
          // æ—¢å­˜ã®ã‚¹ãƒãƒ¼ãƒˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['smart-security', 'automated'],
            state: 'open'
          });
          
          for (const issue of issues.data) {
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed'
            });
          }
          
          // æ–°ã—ã„ã‚¹ãƒãƒ¼ãƒˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£Issueã‚’ä½œæˆ
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['smart-security', 'automated', 'enhancement']
          });

    - name: ğŸ“ˆ Upload Smart Analysis Reports
      uses: actions/upload-artifact@v4
      with:
        name: smart-security-analysis
        path: |
          smart-security-analysis.json
          action-oriented-security-report.json

  # ğŸ”„ è‡ªå‹•ä¿®æ­£ææ¡ˆç”Ÿæˆ
  auto-fix-generator:
    name: ğŸ”§ Auto Fix Suggestion Generator
    runs-on: ubuntu-latest
    needs: [smart-vulnerability-analysis]
    if: always()
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ”§ Generate Automated Fix Suggestions
      run: |
        cat > auto_fix_generator.py << 'EOF'
        import os
        import json
        from datetime import datetime
        
        # è‡ªå‹•ä¿®æ­£ææ¡ˆã‚¨ãƒ³ã‚¸ãƒ³
        def generate_dependency_fixes():
            return {
                'requirements_updates': [
                    {
                        'package': 'requests',
                        'current': '2.25.1',
                        'recommended': '2.32.3',
                        'reason': 'CVE-2024-35195 - SSRF vulnerability fix',
                        'compatibility': 'backward_compatible',
                        'auto_fix_command': 'pip install requests==2.32.3'
                    }
                ]
            }
        
        def generate_code_fixes():
            return {
                'security_patterns': [
                    {
                        'issue': 'Hardcoded credentials',
                        'pattern': 'password = "secret123"',
                        'fix': 'password = os.getenv("APP_PASSWORD")',
                        'explanation': 'ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦Credentialsã‚’å®‰å…¨ã«ç®¡ç†'
                    }
                ]
            }
        
        # ä¿®æ­£ææ¡ˆã®çµ±åˆ
        auto_fixes = {
            'generated_at': datetime.now().isoformat(),
            'fix_categories': {
                'dependencies': generate_dependency_fixes(),
                'code_quality': generate_code_fixes()
            },
            'implementation_guide': {
                'immediate_fixes': [
                    '1. ä¾å­˜é–¢ä¿‚ã®æ›´æ–°ï¼ˆpip install -r requirements.txtï¼‰',
                    '2. ç’°å¢ƒå¤‰æ•°ã®è¨­å®šï¼ˆ.env ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼‰'
                ]
            }
        }
        
        with open('auto-fix-suggestions.json', 'w', encoding='utf-8') as f:
            json.dump(auto_fixes, f, indent=2, ensure_ascii=False)
        
        print('ğŸ”§ è‡ªå‹•ä¿®æ­£ææ¡ˆç”Ÿæˆå®Œäº†')
        EOF
        
        python auto_fix_generator.py

    - name: ğŸ“ Create Auto-Fix Pull Request
      if: github.event.workflow_run.conclusion == 'completed'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          try {
            const autoFixes = JSON.parse(fs.readFileSync('auto-fix-suggestions.json', 'utf8'));
            
            // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£ã®è‡ªå‹•PRä½œæˆï¼ˆè»½å¾®ãªä¿®æ­£ã®ã¿ï¼‰
            const prTitle = 'ğŸ”§ Automated Security Fixes';
            const prBody = \`
            # ğŸ”§ è‡ªå‹•ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£ææ¡ˆ
            
            ã“ã®PRã¯è‡ªå‹•çš„ã«ç”Ÿæˆã•ã‚ŒãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£ææ¡ˆã§ã™ã€‚
            
            ## ğŸ¯ ä¿®æ­£å†…å®¹
            
            ### ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®æ›´æ–°
            \${autoFixes.fix_categories.dependencies.requirements_updates.map(fix => 
              \`- **\${fix.package}**: \${fix.current} â†’ \${fix.recommended}
                - ç†ç”±: \${fix.reason}
                - äº’æ›æ€§: \${fix.compatibility}\`
            ).join('\\n')}
            
            ### âš™ï¸ è¨­å®šã®æ”¹å–„
            \${autoFixes.fix_categories.configuration.github_actions.map(fix =>
              \`- **\${fix.file}**: \${fix.improvement}
                - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŠ¹æœ: \${fix.security_benefit}\`
            ).join('\\n')}
            
            ## âœ… å®Ÿè£…ã‚¬ã‚¤ãƒ‰
            
            ### å³åº§ã®å®Ÿè¡Œ
            \${autoFixes.implementation_guide.immediate_fixes.map(step => \`1. \${step}\`).join('\\n')}
            
            ### æ¤œè¨¼æ‰‹é †
            \${autoFixes.implementation_guide.validation_steps.map(step => \`1. \${step}\`).join('\\n')}
            
            ## âš ï¸ æ³¨æ„äº‹é …
            - ã“ã®ä¿®æ­£ã¯è‡ªå‹•ç”Ÿæˆã®ãŸã‚ã€é©ç”¨å‰ã«å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„
            - ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã®å®Ÿè¡Œã‚’æ¨å¥¨ã—ã¾ã™
            - å•é¡ŒãŒã‚ã‚‹å ´åˆã¯å³åº§ã«revertã—ã¦ãã ã•ã„
            
            ---
            *ã“ã®PRã¯ Smart Security Response ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
            \`;
            
            console.log('è‡ªå‹•ä¿®æ­£PRç”Ÿæˆã®æº–å‚™å®Œäº†ï¼ˆå®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã¯æ‰‹å‹•ç¢ºèªå¾Œã«å®Ÿè¡Œï¼‰');
            console.log('PR Title:', prTitle);
            console.log('ä¿®æ­£é …ç›®æ•°:', autoFixes.fix_categories.dependencies.requirements_updates.length);
            
          } catch (error) {
            console.log('Auto-fix data not available:', error.message);
          }

    - name: ğŸ“ˆ Upload Auto-Fix Reports
      uses: actions/upload-artifact@v4
      with:
        name: auto-fix-suggestions
        path: auto-fix-suggestions.json
