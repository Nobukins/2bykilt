# TASK_QUEUE_SPEC.md

## Overview

The `TASK_QUEUE.yml` file is an auto-generated, machine-readable task queue derived from `ISSUE_DEPENDENCIES.yml`. It provides a prioritized, dependency-aware view of issues organized by status for automation and workflow management.

**⚠️ DO NOT EDIT MANUALLY**: This file is automatically generated by `scripts/generate_task_queue.py`. To make changes, update `docs/roadmap/ISSUE_DEPENDENCIES.yml` and re-run the generator.

## Schema Specification

### Root Level Fields

```yaml
version: 1                          # Schema version (always 1)
generated_at: "2025-08-26T15:47:53.953686+00:00"  # ISO timestamp
roadmap_commit: "abc123..."         # Git commit hash of roadmap
dependencies_commit: "def456..."    # Git commit hash of dependencies file
generation_config: {...}           # Configuration used for generation
diagnostics: {...}                 # Generation diagnostics and metadata
ready: [...]                       # Issues ready for work
blocked: [...]                     # Issues waiting on dependencies
in_progress: [...]                 # Issues currently being worked on
done: [...]                        # Completed issues
```

### Generation Config

```yaml
generation_config:
  repo: "owner/repository"          # GitHub repository
  wip_limit: 5                      # Work-in-progress limit
  max_parallel_per_area: 2          # Max parallel tasks per area
  include_phases: ["1", "2"]        # Included phases (empty = all)
  exclude_risk: ["deprecated"]      # Excluded risk levels
  ordering: [...]                   # Ordering criteria (see below)
  critical_path_higher_is_prior: true  # Critical path ranking direction
```

### Diagnostics

```yaml
diagnostics:
  total_issues: 40                  # Total issues processed
  constraint_violations: [...]      # Soft constraint violations
  api_enrichment_enabled: true      # Whether GitHub API was used
```

### Issue Record Schema

Each issue in the status sections follows this schema:

```yaml
- issue: 64                         # Issue number (integer)
  title: "Feature Flag Framework"   # Issue title
  priority: "P0"                    # Priority (P0=highest, P1, P2, etc.)
  size: "M"                         # Size estimate (S/M/L/XL)
  area: "config"                    # Functional area
  phase: "1"                        # Development phase
  status: "ready"                   # Current status
  depends_on: [32, 65]              # Array of dependency issue numbers
  critical_path_rank: 4             # Critical path ranking (higher = more critical)
  risk: "high"                      # Risk level (null, low, medium, high)
```

## Status Classification Logic

Issues are classified into four status categories:

### `done`
- Issue is closed in GitHub
- Primary PR (if any) is merged
- Represents completed work

### `in_progress`
- Issue has an open primary PR
- Work is actively being done
- Subject to WIP limits

### `blocked`
- Issue has unmet dependencies
- Cannot start until dependencies are completed
- Ordered by priority within blocked state

### `ready`
- All dependencies are met (or no dependencies)
- Issue is open and available for work
- Ordered by generation criteria

## Ordering Semantics

Issues within each status section are ordered according to the `generation_config.ordering` criteria, applied in sequence:

### Primary Ordering Criteria

1. **`critical_path_rank`**: Issues with higher ranks appear first if `critical_path_higher_is_prior` is true
2. **`priority`**: P0 before P1 before P2, etc.
3. **`longest_distance`**: Topological distance from leaf nodes (longer paths first)

### Multi-Criteria Sorting

Ordering is lexicographic across criteria. For example, with ordering `[critical_path_rank, priority]`:
- Issue A (rank=5, P1) comes before Issue B (rank=5, P2)
- Issue C (rank=6, P2) comes before Issue A (rank=5, P1)

## Constraint Management

### Work-in-Progress (WIP) Limits

The `wip_limit` parameter controls how many issues can be `in_progress` simultaneously. Violations are recorded in `diagnostics.constraint_violations` but don't prevent issue inclusion.

### Area Parallelization Limits

The `max_parallel_per_area` parameter limits concurrent work within functional areas (e.g., "runner", "config"). This prevents resource conflicts and promotes focus.

### Soft Constraints

Constraint violations are treated as warnings, not hard failures. The queue includes all eligible issues but flags constraint violations for human review.

## Validation Requirements

The `scripts/validate_task_queue.py` script ensures:

1. **Schema Compliance**: All required fields present with correct types
2. **ID Consistency**: All issue IDs exist in `ISSUE_DEPENDENCIES.yml`
3. **No Duplicates**: Issues appear in exactly one status section
4. **Dependency Logic**: Blocked issues have genuinely unmet dependencies
5. **Ordering Stability**: Order matches declared policy
6. **Constraint Accuracy**: Ready/in_progress issues have dependencies met

## GitHub API Enrichment

When `GITHUB_TOKEN` is available, the generator enriches issue data with:

- **Issue State**: Open/closed status from GitHub
- **Labels**: Current issue labels
- **PR Status**: Primary PR state (open/closed/merged/draft)

This enrichment improves status classification accuracy but is optional.

## Usage Patterns

### Automation Workflow

1. **Daily Generation**: Workflow runs at 3 AM UTC via cron
2. **Event Triggers**: Also runs on dependency file changes
3. **Auto-Commit**: Changes committed only if queue differs
4. **Validation**: Queue validated before commit

### Manual Usage

```bash
# Generate with default settings
python scripts/generate_task_queue.py \
  --repo owner/repo \
  --input docs/roadmap/ISSUE_DEPENDENCIES.yml \
  --output docs/roadmap/TASK_QUEUE.yml

# Generate with custom filters
python scripts/generate_task_queue.py \
  --repo owner/repo \
  --input docs/roadmap/ISSUE_DEPENDENCIES.yml \
  --output docs/roadmap/TASK_QUEUE.yml \
  --wip-limit 3 \
  --include-phases "1" "1-late" \
  --exclude-risk "deprecated" \
  --ordering priority critical_path_rank

# Validate generated queue
python scripts/validate_task_queue.py --verbose
```

## Extension Points

### Future Enhancements

- **Dynamic WIP Adjustment**: Adjust limits based on team capacity
- **Area-Specific Policies**: Different ordering rules per functional area
- **Time-Based Factors**: Consider issue age, deadlines
- **Custom Status**: Additional status categories beyond the core four
- **Integration Hooks**: Webhook notifications, Slack integration

### Custom Ordering Criteria

New ordering criteria can be added by extending the `apply_filters_and_ordering()` function:

```python
elif order_type == 'custom_metric':
    custom_value = calculate_custom_metric(issue)
    keys.append(custom_value)
```

## Error Handling

### Generation Failures

- Missing dependencies file → Fatal error, exit code 1
- GitHub API failures → Warning, continue without enrichment
- Invalid configuration → Fatal error with descriptive message

### Validation Failures

- Schema violations → Error with specific field details
- Logic violations → Error with issue-specific context
- Missing references → Error with affected issue IDs

## Security Considerations

- **Token Handling**: `GITHUB_TOKEN` used read-only for public repositories
- **Input Validation**: All YAML inputs validated before processing
- **Output Sanitization**: Generated content safe for automation consumption

---

*This specification covers Task Queue Schema v1. For questions or enhancement proposals, see the project documentation or create an issue.*