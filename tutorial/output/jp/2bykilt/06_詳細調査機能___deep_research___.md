# Chapter 6: è©³ç´°èª¿æŸ»æ©Ÿèƒ½ (`Deep Research`)


å‰ã®ç« [ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ™ãƒ¼ã‚¹è‡ªå‹•åŒ–](05_ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ™ãƒ¼ã‚¹è‡ªå‹•åŒ–_.md)ã§ã¯ã€`pytest`ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨`llms.txt`ã‚’ä½¿ã£ã¦ã€æ±ºã¾ã£ãŸæ‰‹é †ã®ä½œæ¥­ã‚’é«˜é€Ÿã‹ã¤æ­£ç¢ºã«è‡ªå‹•åŒ–ã™ã‚‹æ–¹æ³•ã‚’å­¦ã³ã¾ã—ãŸã€‚ã“ã‚Œã¯ã€æ¯æ—¥ã®ãƒ«ãƒ¼ãƒãƒ³ãƒ¯ãƒ¼ã‚¯ãªã©ã«éå¸¸ã«ä¾¿åˆ©ã§ã™ã­ã€‚

ã—ã‹ã—ã€ã‚‚ã—ã‚ãªãŸãŒã€Œã‚ã‚‹ç‰¹å®šã®ãƒ†ãƒ¼ãƒã«ã¤ã„ã¦ã€é–¢é€£ã™ã‚‹æƒ…å ±ã‚’ã‚¦ã‚§ãƒ–ã‹ã‚‰å¾¹åº•çš„ã«èª¿ã¹ã¦ã€æœ€æ–°ã®å‹•å‘ã‚„é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’ã¾ã¨ã‚ãŸãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã»ã—ã„ã€ã¨è€ƒãˆãŸã‚‰ã©ã†ã§ã—ã‚‡ã†ï¼Ÿ ã“ã‚Œã¯å˜ãªã‚‹å®šå‹ä½œæ¥­ã®è‡ªå‹•åŒ–ã§ã¯ãªãã€ã‚ˆã‚Šè¤‡é›‘ã§ã€æ·±ã„èª¿æŸ»ã¨æƒ…å ±ã®æ•´ç†ãƒ»çµ±åˆãŒå¿…è¦ãªã‚¿ã‚¹ã‚¯ã§ã™ã€‚

ã“ã®ç« ã§ã¯ã€ã¾ã•ã«ãã®ã‚ˆã†ãªé«˜åº¦ãªè¦æ±‚ã«å¿œãˆã‚‹ãŸã‚ã®æ©Ÿèƒ½ã€**è©³ç´°èª¿æŸ»æ©Ÿèƒ½ (`Deep Research`)** ã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚

## è©³ç´°èª¿æŸ»æ©Ÿèƒ½ (`Deep Research`) ã¨ã¯ï¼Ÿ ãªãœå¿…è¦ï¼Ÿ

ã‚ãªãŸã¯ã€ã‚ã‚‹æœ€æ–°æŠ€è¡“ã€ä¾‹ãˆã°ã€Œå¼·åŒ–å­¦ç¿’ã‚’ç”¨ã„ãŸå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆRLHFï¼‰ã€ã«ã¤ã„ã¦ã€ãã®èµ·æºã‹ã‚‰æœ€æ–°ã®é€²æ­©ã€å°†æ¥ã®å±•æœ›ã¾ã§ã‚’åŒ…æ‹¬çš„ã«èª¿æŸ»ã—ã€ãƒ¬ãƒãƒ¼ãƒˆã«ã¾ã¨ã‚ãŸã„ã¨è€ƒãˆãŸã¨ã—ã¾ã™ã€‚

ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ã«ã¯ã€

1.  ã¾ãšã€ã©ã®ã‚ˆã†ãªæƒ…å ±ã‚’é›†ã‚ã‚‹ã¹ãã‹**èª¿æŸ»è¨ˆç”»**ã‚’ç«‹ã¦ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
2.  æ¬¡ã«ã€è¨ˆç”»ã«åŸºã¥ã„ã¦é©åˆ‡ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ä½•åº¦ã‚‚**ã‚¦ã‚§ãƒ–æ¤œç´¢**ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚
3.  è¦‹ã¤ã‘ãŸã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã‚„è«–æ–‡ï¼ˆPDFãªã©ï¼‰ã‚’èª­ã¿è¾¼ã¿ã€**é‡è¦ãªæƒ…å ±ã‚’æŠ½å‡º**ã—ã¾ã™ã€‚
4.  é›†ã‚ãŸæƒ…å ±ã‚’æ•´ç†ã—ã€é‡è¤‡ã‚’é™¤ãã€**è¦ç‚¹ã‚’ã¾ã¨ã‚**ã¾ã™ã€‚
5.  æœ€å¾Œã«ã€åé›†ãƒ»æ•´ç†ã—ãŸæƒ…å ±ã«åŸºã¥ã„ã¦ã€è«–ç†çš„ãªæ§‹æˆã§**ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆ**ã—ã¾ã™ã€‚

ã“ã‚Œã¯ã¾ã‚‹ã§ã€**ãƒ†ãƒ¼ãƒã‚’ä¸ãˆã‚‰ã‚ŒãŸç ”ç©¶è€…**ãŒè¡Œã†ä½œæ¥­ãã®ã‚‚ã®ã§ã™ã€‚é–¢é€£æ–‡çŒ®ï¼ˆã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆï¼‰ã‚’æ¢ã—ã€å¿…è¦ãªæƒ…å ±ã‚’æŠœãæ›¸ãã—ã€åˆ†æãƒ»è€ƒå¯Ÿã‚’åŠ ãˆã¦ã€æœ€çµ‚çš„ã«ä¸€ã¤ã®ç ”ç©¶ãƒ¬ãƒãƒ¼ãƒˆã«ã¾ã¨ã‚ä¸Šã’ã¾ã™ã€‚

**è©³ç´°èª¿æŸ»æ©Ÿèƒ½ (`Deep Research`)** ã¯ã€ã“ã®ç ”ç©¶è€…ã®ã‚ˆã†ãªä¸€é€£ã®ä½œæ¥­ã‚’è‡ªå¾‹çš„ã«å®Ÿè¡Œã—ã¦ãã‚Œã‚‹æ©Ÿèƒ½ã§ã™ã€‚ã‚ãªãŸãŒèª¿æŸ»ã—ãŸã„ãƒ†ãƒ¼ãƒï¼ˆã‚¿ã‚¹ã‚¯ï¼‰ã‚’ä¸ãˆã‚‹ã ã‘ã§ã€`2bykilt`ãŒå†…éƒ¨ã§LLMã¨[ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (`CustomAgent`)](02_ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ___customagent___.md)ã‚’é§†ä½¿ã—ã¦ã€èª¿æŸ»ã‹ã‚‰ãƒ¬ãƒãƒ¼ãƒˆä½œæˆã¾ã§ã‚’è¡Œã£ã¦ãã‚Œã¾ã™ã€‚

ã“ã®æ©Ÿèƒ½ãŒå¿…è¦ã¨ãªã‚‹ã®ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå ´åˆã§ã™ï¼š

*   ç‰¹å®šã®ãƒˆãƒ”ãƒƒã‚¯ã«ã¤ã„ã¦ã€**ç¶²ç¾…çš„ã‹ã¤æ·±ãèª¿æŸ»**ã—ãŸã„ã€‚
*   è¤‡æ•°ã®æƒ…å ±æºã‹ã‚‰å¾—ãŸæƒ…å ±ã‚’**æ¯”è¼ƒãƒ»æ•´ç†ãƒ»çµ±åˆ**ã—ãŸã„ã€‚
*   èª¿æŸ»çµæœã‚’**æ§‹é€ åŒ–ã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆ**ã¨ã—ã¦ã¾ã¨ã‚ãŸã„ã€‚
*   è¤‡é›‘ãªèª¿æŸ»ãƒ—ãƒ­ã‚»ã‚¹ã‚’**è‡ªå‹•åŒ–**ã—ã¦æ™‚é–“ã‚’ç¯€ç´„ã—ãŸã„ã€‚

`Deep Research`æ©Ÿèƒ½ã‚’ä½¿ãˆã°ã€ã‚ãªãŸã¯èª¿æŸ»ã®ãƒ†ãƒ¼ãƒè¨­å®šã«é›†ä¸­ã§ãã€é¢å€’ãªæƒ…å ±åé›†ã‚„æ•´ç†ã€ãƒ¬ãƒãƒ¼ãƒˆä½œæˆã®å¤§éƒ¨åˆ†ã‚’`2bykilt`ã«ä»»ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã™ã€‚

## ä¸»è¦ãªæ§‹æˆè¦ç´ 

`Deep Research`æ©Ÿèƒ½ã¯ã€å†…éƒ¨ã§ã„ãã¤ã‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’çµŒã¦èª¿æŸ»ã¨ãƒ¬ãƒãƒ¼ãƒˆä½œæˆã‚’é€²ã‚ã¾ã™ã€‚

```mermaid
graph TD
    A[ãƒ¦ãƒ¼ã‚¶ãƒ¼: èª¿æŸ»ã‚¿ã‚¹ã‚¯æŒ‡ç¤º] --> B{èª¿æŸ»è¨ˆç”»ãƒ»ã‚¯ã‚¨ãƒªç”Ÿæˆ (LLM)};
    B -- èª¿æŸ»è¨ˆç”»ã¨æ¤œç´¢ã‚¯ã‚¨ãƒª --> C{ã‚¦ã‚§ãƒ–æ¤œç´¢ãƒ»æƒ…å ±æŠ½å‡º (CustomAgent x Nå›)};
    C -- åé›†ã—ãŸæƒ…å ± --> D{æƒ…å ±è¨˜éŒ²ãƒ»æ•´ç† (LLM)};
    D -- æ•´ç†ã•ã‚ŒãŸæƒ…å ± --> B; subgraph èª¿æŸ»ãƒ«ãƒ¼ãƒ—
    B
    C
    D
    end
    D -- æœ€çµ‚çš„ãªå…¨æƒ…å ± --> E{ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ (LLM)};
    E -- Markdownãƒ¬ãƒãƒ¼ãƒˆ --> F[ãƒ¦ãƒ¼ã‚¶ãƒ¼: çµæœç¢ºèª];

    style B fill:#f9f,stroke:#333,stroke-width:2px
    style C fill:#ccf,stroke:#333,stroke-width:2px
    style D fill:#f9f,stroke:#333,stroke-width:2px
    style E fill:#f9f,stroke:#333,stroke-width:2px
```

1.  **èª¿æŸ»è¨ˆç”»ãƒ»ã‚¯ã‚¨ãƒªç”Ÿæˆ (LLM):**
    *   ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã—ãŸèª¿æŸ»ã‚¿ã‚¹ã‚¯ã¨ã€ã“ã‚Œã¾ã§ã®èª¿æŸ»ã§åé›†ã—ãŸæƒ…å ±ã‚’åŸºã«ã€LLMãŒã€Œæ¬¡ã«ä½•ã‚’èª¿ã¹ã‚‹ã¹ãã‹ã€ã¨ã„ã†**èª¿æŸ»è¨ˆç”»**ã‚’ç«‹ã¦ã€å…·ä½“çš„ãª**æ¤œç´¢ã‚¯ã‚¨ãƒª**ï¼ˆæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã§ä½¿ã†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰ã®ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
2.  **ã‚¦ã‚§ãƒ–æ¤œç´¢ãƒ»æƒ…å ±æŠ½å‡º (CustomAgent x Nå›):**
    *   ç”Ÿæˆã•ã‚ŒãŸå„æ¤œç´¢ã‚¯ã‚¨ãƒªã«ã¤ã„ã¦ã€[ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (`CustomAgent`)](02_ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ___customagent___.md)ãŒèµ·å‹•ã•ã‚Œã¾ã™ã€‚
    *   ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã‚¦ã‚§ãƒ–æ¤œç´¢ã‚’å®Ÿè¡Œã—ã€é–¢é€£æ€§ã®é«˜ãã†ãªãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦æƒ…å ±ã‚’åé›†ã—ã¾ã™ã€‚å ´åˆã«ã‚ˆã£ã¦ã¯ã€ãƒšãƒ¼ã‚¸ã®å†…å®¹ã‚’è¦ç´„ãƒ»æŠ½å‡ºã™ã‚‹ãŸã‚ã®ç‰¹åˆ¥ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä¾‹: `extract_content`ï¼‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚
3.  **æƒ…å ±è¨˜éŒ²ãƒ»æ•´ç† (LLM):**
    *   å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒåé›†ã—ã¦ããŸæƒ…å ±ã‚’ã€åˆ¥ã®LLMï¼ˆè¨˜éŒ²ãƒ»æ•´ç†å½¹ï¼‰ãŒå—ã‘å–ã‚Šã¾ã™ã€‚
    *   ã“ã®LLMã¯ã€æ–°ã—ã„æƒ…å ±ãŒæ—¢å­˜ã®è¨˜éŒ²ã¨é‡è¤‡ã—ã¦ã„ãªã„ã‹ã‚’ç¢ºèªã—ã€é‡è¦ãªæƒ…å ±ã‚’è¦ç´„ã—ã¦ã€æƒ…å ±æºï¼ˆURLã€ã‚¿ã‚¤ãƒˆãƒ«ï¼‰ã¨å…±ã«è¨˜éŒ²ã—ã¾ã™ã€‚ã“ã®éš›ã€ã€Œã“ã®æƒ…å ±ã¯ãƒ¬ãƒãƒ¼ãƒˆã®ã©ã®éƒ¨åˆ†ã§ä½¿ãˆãã†ã‹ã€ã¨ã„ã£ãŸè€ƒå¯Ÿï¼ˆ`thinking`ï¼‰ã‚‚ä»˜ä¸ã•ã‚Œã¾ã™ã€‚
4.  **èª¿æŸ»ãƒ«ãƒ¼ãƒ—:**
    *   ã‚¹ãƒ†ãƒƒãƒ—1ã€œ3ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚æ–°ã—ã„æƒ…å ±ãŒå¾—ã‚‰ã‚Œã‚‹ãŸã³ã«ã€æ¬¡ã®èª¿æŸ»è¨ˆç”»ã¨ã‚¯ã‚¨ãƒªç”Ÿæˆã«åæ˜ ã•ã‚Œã¾ã™ã€‚
    *   LLMãŒã€Œã‚‚ã†ååˆ†ã«æƒ…å ±ãŒé›†ã¾ã£ãŸã€ã¨åˆ¤æ–­ã™ã‚‹ã‹ã€è¨­å®šã•ã‚ŒãŸæœ€å¤§åå¾©å›æ•°ã«é”ã™ã‚‹ã¨ã€ãƒ«ãƒ¼ãƒ—ã¯çµ‚äº†ã—ã¾ã™ã€‚
5.  **ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ (LLM):**
    *   èª¿æŸ»ãƒ«ãƒ¼ãƒ—ã§åé›†ãƒ»æ•´ç†ã•ã‚ŒãŸå…¨ã¦ã®æƒ…å ±ã‚’åŸºã«ã€æœ€çµ‚çš„ãªãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ãŸã‚ã®LLMï¼ˆãƒ¬ãƒãƒ¼ãƒˆä½œæˆå½¹ï¼‰ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
    *   ã“ã®LLMã¯ã€æƒ…å ±ã‚’æ§‹é€ åŒ–ã—ã€è«–ç†çš„ãªæµã‚Œã§è¨˜è¿°ã—ã€å¼•ç”¨æƒ…å ±ãªã©ã‚’é©åˆ‡ã«å«ã‚“ã Markdownå½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚

ã“ã®ä¸€é€£ã®æµã‚Œã‚’é€šã˜ã¦ã€å˜ä¸€ã®æŒ‡ç¤ºã‹ã‚‰åŒ…æ‹¬çš„ãªèª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã®ã§ã™ã€‚

## ä½¿ã£ã¦ã¿ã‚ˆã†ï¼šRLHFã«é–¢ã™ã‚‹ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ

ã§ã¯ã€å®Ÿéš›ã«[Gradioã‚¦ã‚§ãƒ–UI](01_gradioã‚¦ã‚§ãƒ–ui_.md)ã‚’ä½¿ã£ã¦ã€å†’é ­ã®ä¾‹ã€Œå¼·åŒ–å­¦ç¿’ã‚’ç”¨ã„ãŸå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆRLHFï¼‰ã€ã«é–¢ã™ã‚‹ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

1.  **UIã®èµ·å‹•:**
    ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§`2bykilt`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã€`python bykilt.py`ã‚’å®Ÿè¡Œã—ã¦UIã‚’èµ·å‹•ã—ã¾ã™ã€‚

2.  **ã‚¿ãƒ–ã®é¸æŠ:**
    UIä¸Šéƒ¨ã®ã‚¿ãƒ–ã‹ã‚‰ã€Œ**ğŸ§ Deep Research**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

3.  **å…¥åŠ›:**
    *   **Research Task:** èª¿æŸ»ã—ãŸã„å†…å®¹ã‚’å…¥åŠ›ã—ã¾ã™ã€‚ä»Šå›ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å…¥åŠ›ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
        ```
        å¼·åŒ–å­¦ç¿’ã‚’ç”¨ã„ãŸå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆRLHFï¼‰ã«ã¤ã„ã¦ã€ãã®èµ·æºã€ç¾åœ¨ã®é€²æ­©ã€å°†æ¥ã®å±•æœ›ã‚’ã€é–¢é€£ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚„æŠ€è¡“ã®ä¾‹ã‚’æŒ™ã’ã¦åŒ…æ‹¬çš„ã«èª¿æŸ»ã—ã€ç‹¬è‡ªã®æ´å¯Ÿã¨åˆ†æã‚’åŠ ãˆãŸãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚å˜ãªã‚‹æ—¢å­˜æ–‡çŒ®ã®è¦ç´„ã«ã¨ã©ã¾ã‚‰ãªã„å†…å®¹ã‚’æœŸå¾…ã—ã¾ã™ã€‚
        ```
    *   **Max Search Iteration:** èª¿æŸ»ãƒ«ãƒ¼ãƒ—ã®æœ€å¤§åå¾©å›æ•°ã‚’æŒ‡å®šã—ã¾ã™ã€‚åå¾©å›æ•°ãŒå¤šã„ã»ã©æ·±ãèª¿æŸ»ã—ã¾ã™ãŒã€æ™‚é–“ã‚‚ã‹ã‹ã‚Šã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯`3`ã§ã™ã€‚ä»Šå›ã¯`3`ã®ã¾ã¾ã«ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
    *   **Max Query per Iteration:** 1å›ã®èª¿æŸ»ãƒ«ãƒ¼ãƒ—ã§ç”Ÿæˆãƒ»å®Ÿè¡Œã™ã‚‹æ¤œç´¢ã‚¯ã‚¨ãƒªã®æœ€å¤§æ•°ã‚’æŒ‡å®šã—ã¾ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯`1`ã§ã™ã€‚ï¼ˆè¤‡æ•°ã«ã™ã‚‹ã¨ä¸¦åˆ—ã§ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå‹•ãã¾ã™ãŒã€è¤‡é›‘ã«ãªã‚‹ãŸã‚æœ€åˆã¯`1`ãŒãŠã™ã™ã‚ã§ã™ï¼‰
    *   **LLM/Browserè¨­å®š:** ã€ŒğŸ”§ LLM Configurationã€ã‚„ã€ŒğŸŒ Browser Settingsã€ã‚¿ãƒ–ã®è¨­å®šãŒã“ã“ã§ã‚‚ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ç¢ºèªãƒ»èª¿æ•´ã—ã¦ãã ã•ã„ã€‚ï¼ˆç‰¹ã«ã€æ€§èƒ½ã®é«˜ã„LLMã‚’é¸æŠã™ã‚‹ã¨ã€ãƒ¬ãƒãƒ¼ãƒˆã®è³ªãŒå‘ä¸Šã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰

4.  **å®Ÿè¡Œ:**
    ã€Œ**â–¶ï¸ Run Deep Research**ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

5.  **å®Ÿè¡Œã®ç›£è¦–ã¨çµæœç¢ºèª:**
    *   å®Ÿè¡ŒãŒé–‹å§‹ã•ã‚Œã‚‹ã¨ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§èª¿æŸ»ãƒ—ãƒ­ã‚»ã‚¹ãŒé€²è¡Œã—ã¾ã™ã€‚UIä¸Šã«ã¯ç›´æ¥çš„ãªãƒ©ã‚¤ãƒ–ãƒ“ãƒ¥ãƒ¼ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ãŒã€å‡¦ç†ãŒé€²ã‚“ã§ã„ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
    *   èª¿æŸ»ãƒ—ãƒ­ã‚»ã‚¹ã¯ã€åå¾©å›æ•°ã‚„èª¿æŸ»å†…å®¹ã«ã‚ˆã‚Šã¾ã™ãŒã€æ•°åˆ†ã‹ã‚‰æ•°ååˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
    *   é€”ä¸­ã§èª¿æŸ»ã‚’æ­¢ã‚ãŸã„å ´åˆã¯ã€ã€Œ**â¹ï¸ Stop**ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚ãƒ—ãƒ­ã‚»ã‚¹ã¯å®‰å…¨ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§åœæ­¢ã—ã¾ã™ã€‚
    *   èª¿æŸ»ã¨ãƒ¬ãƒãƒ¼ãƒˆç”ŸæˆãŒå®Œäº†ã™ã‚‹ã¨ã€ã€Œ**Research Report**ã€ã‚¨ãƒªã‚¢ã«ç”Ÿæˆã•ã‚ŒãŸMarkdownå½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
    *   ã€Œ**Download Research Report**ã€ã«ã¯ã€ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆã®Markdownãƒ•ã‚¡ã‚¤ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚

ã“ã‚Œã§ã€æŒ‡å®šã—ãŸãƒ†ãƒ¼ãƒã«é–¢ã™ã‚‹èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆãŒè‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆã®å†…å®¹ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦æ‰‹ç›´ã—ã‚’åŠ ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## å†…éƒ¨ã®ä»•çµ„ã¿ï¼šDeep Researchã¯ã©ã®ã‚ˆã†ã«å‹•ãï¼Ÿ

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œâ–¶ï¸ Run Deep Researchã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸå¾Œã€`2bykilt`ã®å†…éƒ¨ã§ã¯ã©ã®ã‚ˆã†ãªå‡¦ç†ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

### ã‚¹ãƒ†ãƒƒãƒ—ãƒ»ãƒã‚¤ãƒ»ã‚¹ãƒ†ãƒƒãƒ—ã®æµã‚Œ

1.  **UIã‹ã‚‰ã®å…¥åŠ›:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èª¿æŸ»ã‚¿ã‚¹ã‚¯ã¨è¨­å®šï¼ˆåå¾©å›æ•°ãªã©ï¼‰ã‚’å…¥åŠ›ã—ã€å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚
2.  **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‘¼ã³å‡ºã—:** Gradio UIã¯ã€ã“ã‚Œã‚‰ã®æƒ…å ±ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® `run_deep_search` é–¢æ•° (`bykilt.py`å†…) ã«æ¸¡ã—ã¾ã™ã€‚
3.  **`deep_research` é–¢æ•°ã®å®Ÿè¡Œ:** `run_deep_search` é–¢æ•°ã¯ã€å—ã‘å–ã£ãŸæƒ…å ±ã‚’ä½¿ã£ã¦ `src/utils/deep_research.py` å†…ã® `deep_research` é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚ã“ã“ã‹ã‚‰ãŒèª¿æŸ»ã®æœ¬ä½“ã§ã™ã€‚
4.  **èª¿æŸ»ãƒ«ãƒ¼ãƒ—é–‹å§‹:** `deep_research` é–¢æ•°å†…ã§ã€æŒ‡å®šã•ã‚ŒãŸæœ€å¤§åå¾©å›æ•° (`max_search_iterations`) ã«é”ã™ã‚‹ã¾ã§ã€ã¾ãŸã¯ç”Ÿæˆã•ã‚Œã‚‹æ¤œç´¢ã‚¯ã‚¨ãƒªãŒãªããªã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—å‡¦ç†ãŒå§‹ã¾ã‚Šã¾ã™ã€‚
5.  **è¨ˆç”»ã¨ã‚¯ã‚¨ãƒªç”Ÿæˆ:**
    *   ç¾åœ¨ã®åå¾©å›æ•°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆæœŸæŒ‡ç¤ºã€éå»ã®ã‚¯ã‚¨ãƒªå±¥æ­´ã€ã“ã‚Œã¾ã§ã«è¨˜éŒ²ã•ã‚ŒãŸæƒ…å ± (`history_infos`) ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã—ã¦çµ„ã¿ç«‹ã¦ã¾ã™ã€‚
    *   ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’**èª¿æŸ»è¨ˆç”»LLM**ã«é€ä¿¡ã—ã¾ã™ã€‚
    *   LLMã¯ã€èª¿æŸ»è¨ˆç”» (`plan`) ã¨æ¬¡ã®æ¤œç´¢ã‚¯ã‚¨ãƒªãƒªã‚¹ãƒˆ (`queries`) ã‚’å«ã‚€JSONã‚’è¿”ã—ã¾ã™ã€‚
    *   è¿”ã•ã‚ŒãŸã‚¯ã‚¨ãƒªãŒç©ºãƒªã‚¹ãƒˆ `[]` ã§ã‚ã‚Œã°ã€ãƒ«ãƒ¼ãƒ—ã‚’çµ‚äº†ã—ã¾ã™ã€‚
6.  **ã‚¦ã‚§ãƒ–æ¤œç´¢ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè¡Œ:**
    *   ç”Ÿæˆã•ã‚ŒãŸå„æ¤œç´¢ã‚¯ã‚¨ãƒª (`queries`) ã«å¯¾ã—ã¦ã€[ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (`CustomAgent`)](02_ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ___customagent___.md)ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™ã€‚
    *   å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã€å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸã‚¯ã‚¨ãƒªã§ã‚¦ã‚§ãƒ–æ¤œç´¢ã‚’è¡Œã„ã€é–¢é€£æƒ…å ±ã‚’åé›†ã—ã¾ã™ã€‚ã“ã®éš›ã€å¿…è¦ã«å¿œã˜ã¦ãƒšãƒ¼ã‚¸å†…å®¹ã‚’æŠ½å‡ºã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ`extract_content`ãªã©ã€`deep_research.py`å†…ã§å®šç¾©ãƒ»ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
    *   å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè¡Œçµæœï¼ˆåé›†ã—ãŸãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ï¼‰ãŒ `query_results` ã¨ã—ã¦é›†ã‚ã‚‰ã‚Œã¾ã™ã€‚
    *   ï¼ˆ`_global_agent_state.is_stop_requested()` ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€åœæ­¢è¦æ±‚ãŒã‚ã‚Œã°ãƒ«ãƒ¼ãƒ—ã‚’ä¸­æ–­ã—ã¾ã™ã€‚ï¼‰
7.  **æƒ…å ±è¨˜éŒ²:**
    *   å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè¡Œçµæœ (`query_results`) ã‚’ä¸€ã¤ãšã¤å‡¦ç†ã—ã¾ã™ã€‚
    *   ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡ç¤ºã€ç¾åœ¨ã®èª¿æŸ»è¨ˆç”»ã€ç¾åœ¨ã®ã‚¯ã‚¨ãƒªã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®åé›†çµæœã€ãã—ã¦ã“ã‚Œã¾ã§ã®è¨˜éŒ²æƒ…å ± (`history_infos`) ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã—ã¦çµ„ã¿ç«‹ã¦ã¾ã™ã€‚
    *   ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’**æƒ…å ±è¨˜éŒ²LLM**ã«é€ä¿¡ã—ã¾ã™ã€‚
    *   LLMã¯ã€æ–°ã—ã„æƒ…å ±ã‚’è¦ç´„ã—ã€æƒ…å ±æºï¼ˆURLã€ã‚¿ã‚¤ãƒˆãƒ«ï¼‰ã€ãã—ã¦è€ƒå¯Ÿï¼ˆ`thinking`ï¼‰ã‚’ä»˜ä¸ã—ãŸJSONå½¢å¼ã®ãƒªã‚¹ãƒˆ (`new_record_infos`) ã‚’è¿”ã—ã¾ã™ã€‚ã“ã®éš›ã€æ—¢å­˜ã®æƒ…å ±ã¨ã®é‡è¤‡ã‚’é¿ã‘ã‚‹ã‚ˆã†ã«æŒ‡ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚
    *   è¿”ã•ã‚ŒãŸ `new_record_infos` ã‚’å…¨ä½“ã®è¨˜éŒ²æƒ…å ± `history_infos` ã«è¿½åŠ ã—ã¾ã™ã€‚
    *   ï¼ˆ`_global_agent_state.is_stop_requested()` ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€åœæ­¢è¦æ±‚ãŒã‚ã‚Œã°ãƒ«ãƒ¼ãƒ—ã‚’ä¸­æ–­ã—ã¾ã™ã€‚ï¼‰
8.  **ãƒ«ãƒ¼ãƒ—çµ‚äº†ã¨ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ:**
    *   èª¿æŸ»ãƒ«ãƒ¼ãƒ—ãŒçµ‚äº†ã—ãŸå¾Œã€`deep_research` é–¢æ•°ã¯ `generate_final_report` é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
    *   `generate_final_report` é–¢æ•°ã¯ã€æœ€çµ‚çš„ã«è“„ç©ã•ã‚ŒãŸå…¨è¨˜éŒ²æƒ…å ± (`history_infos`) ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åˆæœŸæŒ‡ç¤ºã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ã—ã¦çµ„ã¿ç«‹ã¦ã¾ã™ã€‚
    *   ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’**ãƒ¬ãƒãƒ¼ãƒˆç”ŸæˆLLM**ã«é€ä¿¡ã—ã¾ã™ã€‚
    *   LLMã¯ã€æƒ…å ±ã‚’æ•´ç†ãƒ»æ§‹é€ åŒ–ã—ã€Markdownå½¢å¼ã®æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆ (`report_content`) ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
    *   ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆã¯ãƒ•ã‚¡ã‚¤ãƒ« (`final_report.md`) ã«ã‚‚ä¿å­˜ã•ã‚Œã¾ã™ã€‚
9.  **çµæœã®è¿”å´:** `deep_research` é–¢æ•°ã¯ã€ç”Ÿæˆã•ã‚ŒãŸãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ (`report_content`) ã¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ `run_deep_search` é–¢æ•°ã«è¿”ã—ã¾ã™ã€‚
10. **UIã¸ã®è¡¨ç¤º:** `run_deep_search` é–¢æ•°ã¯ã€å—ã‘å–ã£ãŸãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’Gradio UIã«è¿”ã—ã€ãã‚Œãã‚Œã€ŒResearch Reportã€ã‚¨ãƒªã‚¢ã¨ã€ŒDownload Research Reportã€ã«è¡¨ç¤ºã•ã›ã¾ã™ã€‚

### ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³

ã“ã®è¤‡é›‘ãªæµã‚Œã‚’ã€ä¸»è¦ãªç™»å ´äººç‰©ã«çµã£ã¦ç°¡å˜ãªã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã§è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant GradioUI as Gradio UI
    participant Backend as ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (bykilt.py)
    participant DeepResearch as deep_research.py
    participant PlanLLM as è¨ˆç”»LLM
    participant Agent as Webæ¤œç´¢Agent
    participant RecordLLM as è¨˜éŒ²LLM
    participant ReportLLM as ãƒ¬ãƒãƒ¼ãƒˆLLM

    User->>GradioUI: èª¿æŸ»ã‚¿ã‚¹ã‚¯å…¥åŠ›ã€å®Ÿè¡Œ
    GradioUI->>Backend: run_deep_search(ã‚¿ã‚¹ã‚¯, è¨­å®š)
    Backend->>DeepResearch: deep_research(ã‚¿ã‚¹ã‚¯, LLM, ...)

    loop èª¿æŸ»ãƒ«ãƒ¼ãƒ— (æœ€å¤§åå¾©å›æ•°ã¾ã§ or ã‚¯ã‚¨ãƒªãŒãªããªã‚‹ã¾ã§)
        DeepResearch->>PlanLLM: è¨ˆç”»ã¨ã‚¯ã‚¨ãƒªç”Ÿæˆä¾é ¼ (å±¥æ­´æƒ…å ±å«ã‚€)
        PlanLLM-->>DeepResearch: èª¿æŸ»è¨ˆç”», æ¤œç´¢ã‚¯ã‚¨ãƒªãƒªã‚¹ãƒˆ
        alt ã‚¯ã‚¨ãƒªãƒªã‚¹ãƒˆãŒç©º
            DeepResearch-->> Backend: ãƒ«ãƒ¼ãƒ—çµ‚äº†
            break
        end
        par å„æ¤œç´¢ã‚¯ã‚¨ãƒªã«ã¤ã„ã¦ä¸¦åˆ—å®Ÿè¡Œ (max_query_per_iter > 1 ã®å ´åˆ)
            DeepResearch->>Agent: CustomAgentå®Ÿè¡Œ (ã‚¯ã‚¨ãƒªæŒ‡ç¤º)
            Agent-->>DeepResearch: åé›†ã—ãŸæƒ…å ±
        end
        DeepResearch->>RecordLLM: æƒ…å ±è¨˜éŒ²ä¾é ¼ (åé›†æƒ…å ±, å±¥æ­´æƒ…å ±å«ã‚€)
        RecordLLM-->>DeepResearch: æ–°è¦è¨˜éŒ²æƒ…å ± (JSONãƒªã‚¹ãƒˆ)
        DeepResearch->>DeepResearch: å…¨ä½“è¨˜éŒ²æƒ…å ±ã‚’æ›´æ–°
    end

    DeepResearch->>ReportLLM: ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¾é ¼ (å…¨è¨˜éŒ²æƒ…å ±)
    ReportLLM-->>DeepResearch: Markdownãƒ¬ãƒãƒ¼ãƒˆ
    DeepResearch-->>Backend: ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹, ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
    Backend-->>GradioUI: ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤ºã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š
    GradioUI-->>User: çµæœç¢ºèª
```

### ã‚³ãƒ¼ãƒ‰ã§ã®å®Ÿè£…

é–¢é€£ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®ä¸»è¦ãªéƒ¨åˆ†ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚å†…éƒ¨å®Ÿè£…ã¯è¤‡é›‘ãªãŸã‚ã€ã“ã“ã§ã¯æ§‹é€ ã¨ä¸»è¦ãªé–¢æ•°å‘¼ã³å‡ºã—ã«ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™ã€‚

1.  **UIã‹ã‚‰ã®å‘¼ã³å‡ºã—èµ·ç‚¹ (`bykilt.py`)**

    ```python
    # --- File: bykilt.py ---
    async def run_deep_search(research_task, max_search_iteration_input, max_query_per_iter_input, llm_provider, llm_model_name, llm_num_ctx, llm_temperature, llm_base_url, llm_api_key, use_vision, use_own_browser, headless):
        from src.utils.deep_research import deep_research # deep_researché–¢æ•°ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        global _global_agent_state
        _global_agent_state.clear_stop() # åœæ­¢ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ

        # LLMã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’åˆæœŸåŒ–
        llm = utils.get_llm_model(
            provider=llm_provider, model_name=llm_model_name, num_ctx=llm_num_ctx,
            temperature=llm_temperature, base_url=llm_base_url, api_key=llm_api_key,
        )
        # ãƒ¡ã‚¤ãƒ³ã®èª¿æŸ»é–¢æ•°ã‚’å‘¼ã³å‡ºã™
        markdown_content, file_path = await deep_research(
            research_task, llm, _global_agent_state, # ã‚¿ã‚¹ã‚¯ã€LLMã€åœæ­¢çŠ¶æ…‹ã‚’æ¸¡ã™
            max_search_iterations=max_search_iteration_input,
            max_query_num=max_query_per_iter_input,
            use_vision=use_vision, headless=headless,
            use_own_browser=use_own_browser
        )
        # çµæœã‚’UIã«è¿”ã™
        return markdown_content, file_path, gr.update(value="Stop", interactive=True), gr.update(interactive=True)

    # ... (create_ui é–¢æ•°å†…ã§ research_button.click ã« run_deep_search ã‚’è¨­å®š) ...
    research_button.click(
        fn=run_deep_search,
        inputs=[research_task_input, max_search_iteration_input, max_query_per_iter_input, llm_provider, llm_model_name, llm_num_ctx, llm_temperature, llm_base_url, llm_api_key, use_vision, use_own_browser, headless],
        outputs=[markdown_output_display, markdown_download, stop_research_button, research_button]
    )
    stop_research_button.click(fn=stop_research_agent, inputs=[], outputs=[stop_research_button, research_button])
    ```
    *   Gradio UIã®ã€Œâ–¶ï¸ Run Deep Researchã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã‚‹ã¨ã€`run_deep_search`é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚
    *   å¿…è¦ãªLLMã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’æº–å‚™ã—ã€`src/utils/deep_research.py` ã® `deep_research` é–¢æ•°ã‚’ `await` ã§å‘¼ã³å‡ºã—ã¦ã€èª¿æŸ»ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹ã—ã¾ã™ã€‚
    *   `_global_agent_state` ã‚’æ¸¡ã™ã“ã¨ã§ã€èª¿æŸ»ä¸­ã«åœæ­¢ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã“ã¨ã‚’æ¤œçŸ¥ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

2.  **ãƒ¡ã‚¤ãƒ³ã®èª¿æŸ»ãƒ«ãƒ¼ãƒ— (`src/utils/deep_research.py`)**

    ```python
    # --- File: src/utils/deep_research.py ---
    import asyncio
    # ... ä»–ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ...
    from src.agent.custom_agent import CustomAgent
    from src.controller.custom_controller import CustomController
    from browser_use.agent.views import ActionResult
    # ...

    async def deep_research(task, llm, agent_state=None, **kwargs):
        # ... (åˆæœŸè¨­å®šã€ä¿å­˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆãªã©) ...
        max_query_num = kwargs.get("max_query_num", 3)
        # ... (ãƒ–ãƒ©ã‚¦ã‚¶ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®æº–å‚™) ...
        controller = CustomController() # ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ä½¿ç”¨

        # ãƒšãƒ¼ã‚¸å†…å®¹æŠ½å‡ºç”¨ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ãƒ»ç™»éŒ²
        @controller.registry.action('Extract page content to get the pure markdown.')
        async def extract_content(browser: BrowserContext):
            # ... (Jina Readerã‚’ä½¿ã£ã¦Markdownã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æŠ½å‡ºã™ã‚‹å‡¦ç†) ...
            return ActionResult(extracted_content=msg)

        search_system_prompt = f""" ... (èª¿æŸ»è¨ˆç”»LLMç”¨ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ) ... """
        search_messages = [SystemMessage(content=search_system_prompt)]
        record_system_prompt = """ ... (æƒ…å ±è¨˜éŒ²LLMç”¨ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ) ... """
        record_messages = [SystemMessage(content=record_system_prompt)]

        search_iteration = 0
        max_search_iterations = kwargs.get("max_search_iterations", 10)
        history_query = [] # éå»ã®ã‚¯ã‚¨ãƒªå±¥æ­´
        history_infos = [] # è¨˜éŒ²ã•ã‚ŒãŸæƒ…å ±

        try:
            while search_iteration < max_search_iterations: # èª¿æŸ»ãƒ«ãƒ¼ãƒ—
                search_iteration += 1
                logger.info(f"Start {search_iteration}th Search...")
                # ... (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæº–å‚™) ...

                # 1. è¨ˆç”»ã¨ã‚¯ã‚¨ãƒªç”ŸæˆLLMå‘¼ã³å‡ºã—
                ai_query_msg = llm.invoke(search_messages[:1] + search_messages[1:][-1:])
                # ... (å¿œç­”ã®ãƒ‘ãƒ¼ã‚¹ã€è¨ˆç”»ã¨ã‚¯ã‚¨ãƒªå–å¾—) ...
                query_tasks = ai_query_content["queries"]
                if not query_tasks: break # ã‚¯ã‚¨ãƒªãŒãªã‘ã‚Œã°çµ‚äº†
                # ... (ã‚¯ã‚¨ãƒªå±¥æ­´ã«è¿½åŠ ) ...

                # 2. ã‚¦ã‚§ãƒ–æ¤œç´¢ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œ
                #    (CustomAgentã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã€ä¸¦åˆ—ã¾ãŸã¯é€æ¬¡å®Ÿè¡Œ)
                agents = [CustomAgent(task=q_task, llm=llm, ..., controller=controller) for q_task in query_tasks]
                query_results = await asyncio.gather(*[agent.run(...) for agent in agents])

                # åœæ­¢ãƒã‚§ãƒƒã‚¯
                if agent_state and agent_state.is_stop_requested(): break

                # 3. æƒ…å ±è¨˜éŒ²LLMå‘¼ã³å‡ºã—
                for i in range(len(query_tasks)):
                    # ... (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæº–å‚™: ã‚¯ã‚¨ãƒªçµæœã€å±¥æ­´æƒ…å ±ãªã©) ...
                    record_prompt = f"..."
                    record_messages.append(HumanMessage(content=record_prompt))
                    ai_record_msg = llm.invoke(record_messages[:1] + record_messages[-1:])
                    # ... (å¿œç­”ãƒ‘ãƒ¼ã‚¹ã€æ–°è¦è¨˜éŒ²æƒ…å ±å–å¾—) ...
                    new_record_infos = json.loads(record_content)
                    history_infos.extend(new_record_infos) # å…¨ä½“è¨˜éŒ²ã«è¿½åŠ 

                # åœæ­¢ãƒã‚§ãƒƒã‚¯
                if agent_state and agent_state.is_stop_requested(): break

            logger.info("Finish Searching, Start Generating Report...")
            # 4. ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
            return await generate_final_report(task, history_infos, save_dir, llm)

        except Exception as e:
            # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€éƒ¨åˆ†çš„ãªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚’è©¦ã¿ã‚‹
            return await generate_final_report(task, history_infos, save_dir, llm, str(e))
        finally:
            # ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãªã©
            # ...
    ```
    *   `deep_research` é–¢æ•°ãŒå…¨ä½“ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ‹…å½“ã—ã¾ã™ã€‚
    *   ãƒ«ãƒ¼ãƒ—å†…ã§ã€è¨ˆç”»LLMã€`CustomAgent`ï¼ˆè¤‡æ•°å›ï¼‰ã€è¨˜éŒ²LLMã‚’é †ç•ªã«å‘¼ã³å‡ºã—ã¾ã™ã€‚
    *   `CustomAgent` ã«ã¯ `CustomController` ã‚’æ¸¡ã—ã¦ãŠã‚Šã€å¿…è¦ã«å¿œã˜ã¦ `extract_content` ã®ã‚ˆã†ãªã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚
    *   åœæ­¢çŠ¶æ…‹ (`agent_state`) ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€æ—©æœŸã«ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
    *   ãƒ«ãƒ¼ãƒ—çµ‚äº†å¾Œã€`generate_final_report` é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

3.  **æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ (`src/utils/deep_research.py`)**

    ```python
    # --- File: src/utils/deep_research.py ---
    async def generate_final_report(task, history_infos, save_dir, llm, error_msg=None):
        try:
            logger.info("Attempting to generate final report...")
            writer_system_prompt = """ ... (ãƒ¬ãƒãƒ¼ãƒˆç”ŸæˆLLMç”¨ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ) ... """
            # ... (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæº–å‚™: ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡ç¤ºã€å…¨è¨˜éŒ²æƒ…å ±) ...
            report_prompt = f"User Instruction:{task} \n Search Information:\n {history_infos_}"
            report_messages = [SystemMessage(content=writer_system_prompt), HumanMessage(content=report_prompt)]

            # ãƒ¬ãƒãƒ¼ãƒˆç”ŸæˆLLMå‘¼ã³å‡ºã—
            ai_report_msg = llm.invoke(report_messages)
            # ... (å¿œç­”ã‹ã‚‰ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ã‚’æŠ½å‡ºã€Markdownå½¢å¼ã«æ•´å½¢) ...
            report_content = ai_report_msg.content
            report_content = re.sub(...) # Markdownæ•´å½¢
            report_content = report_content.strip()

            # ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°ãƒ¬ãƒãƒ¼ãƒˆå†’é ­ã«è¿½è¨˜
            if error_msg:
                report_content = f"## âš ï¸ Research Incomplete ...\n{error_msg}\n\n{report_content}"

            # ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
            report_file_path = os.path.join(save_dir, "final_report.md")
            with open(report_file_path, "w", encoding="utf-8") as f:
                f.write(report_content)
            logger.info(f"Save Report at: {report_file_path}")
            return report_content, report_file_path

        except Exception as report_error:
            # ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆè‡ªä½“ãŒå¤±æ•—ã—ãŸå ´åˆ
            logger.error(f"Failed to generate report: {report_error}")
            return f"Error generating report: {str(report_error)}", None
    ```
    *   `generate_final_report` é–¢æ•°ã¯ã€åé›†ã•ã‚ŒãŸå…¨æƒ…å ± (`history_infos`) ã‚’ä½¿ã£ã¦ã€ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆç”¨ã®LLMã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
    *   LLMã‹ã‚‰ã®å¿œç­”ã‚’æ•´å½¢ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ã€ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’è¿”ã—ã¾ã™ã€‚
    *   èª¿æŸ»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ãŸå ´åˆã€ãã®æ—¨ã‚’ãƒ¬ãƒãƒ¼ãƒˆã®å†’é ­ã«è¿½è¨˜ã—ã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã€`Deep Research` æ©Ÿèƒ½ã¯ã€è¤‡æ•°ã®LLMå‘¼ã³å‡ºã—ã¨è¤‡æ•°å›ã® `CustomAgent` å®Ÿè¡Œã‚’çµ„ã¿åˆã‚ã›ã€èª¿æŸ»è¨ˆç”»ã€æƒ…å ±åé›†ã€æƒ…å ±æ•´ç†ã€ãƒ¬ãƒãƒ¼ãƒˆä½œæˆã¨ã„ã†ä¸€é€£ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’è‡ªå¾‹çš„ã«å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

## ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€`2bykilt`ã®é«˜åº¦ãªæ©Ÿèƒ½ã§ã‚ã‚‹**è©³ç´°èª¿æŸ»æ©Ÿèƒ½ (`Deep Research`)** ã«ã¤ã„ã¦å­¦ã³ã¾ã—ãŸã€‚

*   ç‰¹å®šã®ãƒ†ãƒ¼ãƒã«ã¤ã„ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŒ‡ç¤ºã«åŸºã¥ã„ã¦**è‡ªå¾‹çš„ã«èª¿æŸ»**ã‚’é€²ã‚ã‚‹æ©Ÿèƒ½ã§ã‚ã‚‹ã“ã¨ã€‚
*   å†…éƒ¨ã§ã¯ã€**èª¿æŸ»è¨ˆç”»ãƒ»ã‚¯ã‚¨ãƒªç”Ÿæˆ(LLM) â†’ ã‚¦ã‚§ãƒ–æ¤œç´¢ãƒ»æƒ…å ±æŠ½å‡º(CustomAgent) â†’ æƒ…å ±è¨˜éŒ²ãƒ»æ•´ç†(LLM)** ã¨ã„ã†ã‚µã‚¤ã‚¯ãƒ«ã‚’ç¹°ã‚Šè¿”ã—ã€æœ€å¾Œã«**ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ(LLM)** ã‚’è¡Œã†ã“ã¨ã€‚
*   [Gradioã‚¦ã‚§ãƒ–UI](01_gradioã‚¦ã‚§ãƒ–ui_.md)ã®ã€ŒğŸ§ Deep Researchã€ã‚¿ãƒ–ã‹ã‚‰ç°¡å˜ã«åˆ©ç”¨ã§ãã€è¤‡é›‘ãªèª¿æŸ»ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•åŒ–ã—ã¦**Markdownå½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆ**ã‚’å¾—ã‚‰ã‚Œã‚‹ã“ã¨ã€‚
*   é€”ä¸­ã§èª¿æŸ»ã‚’**åœæ­¢**ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã€‚

ã“ã®æ©Ÿèƒ½ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚ãªãŸã¯æƒ…å ±åé›†ã‚„ãƒ¬ãƒãƒ¼ãƒˆä½œæˆã®æ™‚é–“ã‚’å¤§å¹…ã«ç¯€ç´„ã—ã€ã‚ˆã‚Šæœ¬è³ªçš„ãªåˆ†æã‚„è€ƒå¯Ÿã«é›†ä¸­ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚

---

ã“ã‚Œã§ã€`2bykilt`ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®ä¸»è¦ãªæ©Ÿèƒ½ã‚’ä¸€é€šã‚Šå­¦ã³çµ‚ãˆã¾ã—ãŸã€‚æœ€åˆã®ç« [Gradioã‚¦ã‚§ãƒ–UI](01_gradioã‚¦ã‚§ãƒ–ui_.md)ã‹ã‚‰å§‹ã¾ã‚Šã€[ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (`CustomAgent`)](02_ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ___customagent___.md)ã€[LLMé€£æºã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ](03_llmé€£æºã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ_.md)ã€[ãƒ–ãƒ©ã‚¦ã‚¶åˆ¶å¾¡ã¨ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³](04_ãƒ–ãƒ©ã‚¦ã‚¶åˆ¶å¾¡ã¨ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³_.md)ã€[ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ™ãƒ¼ã‚¹è‡ªå‹•åŒ–](05_ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ™ãƒ¼ã‚¹è‡ªå‹•åŒ–_.md)ã€ãã—ã¦ã“ã®ç« ã®[è©³ç´°èª¿æŸ»æ©Ÿèƒ½ (`Deep Research`)](06_è©³ç´°èª¿æŸ»æ©Ÿèƒ½___deep_research___.md)ã¾ã§ã€`2bykilt`ãŒã©ã®ã‚ˆã†ã«å‹•ä½œã—ã€ã‚¦ã‚§ãƒ–æ“ä½œã‚’è‡ªå‹•åŒ–ã™ã‚‹ã‹ã‚’ç†è§£ã§ããŸã¯ãšã§ã™ã€‚

ã“ã‚Œã‚‰ã®çŸ¥è­˜ã‚’åŸºã«ã€ãœã²ã‚ãªãŸè‡ªèº«ã®ã‚¿ã‚¹ã‚¯è‡ªå‹•åŒ–ã‚„èª¿æŸ»ã«`2bykilt`ã‚’æ´»ç”¨ã—ã¦ã¿ã¦ãã ã•ã„ï¼

---

Generated by [AI Codebase Knowledge Builder](https://github.com/The-Pocket/Tutorial-Codebase-Knowledge)