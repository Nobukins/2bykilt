# Chapter 2: ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (`CustomAgent`)

å‰ã®ç« [Gradioã‚¦ã‚§ãƒ–UI](01_gradioã‚¦ã‚§ãƒ–ui_.md)ã§ã¯ã€`2bykilt`ã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ã‚³ãƒƒã‚¯ãƒ”ãƒƒãƒˆã§ã‚ã‚‹UIã®ä½¿ã„æ–¹ã‚’å­¦ã³ã¾ã—ãŸã€‚ã‚¿ã‚¹ã‚¯ã‚’å…¥åŠ›ã—ã€å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ã°ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå‹•ãå‡ºã™ã“ã¨ã¯ã‚ã‹ã‚Šã¾ã—ãŸãŒã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ä¸€ä½“ã©ã®ã‚ˆã†ã«ã—ã¦ç§ãŸã¡ã®æŒ‡ç¤ºã‚’ç†è§£ã—ã€è³¢ãæŒ¯ã‚‹èˆã£ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ ç‰¹ã«ã€ã‚‚ã£ã¨è¤‡é›‘ãªæŒ‡ç¤ºã‚„ã€çŠ¶æ³ã«å¿œã˜ãŸæŸ”è»Ÿãªå¯¾å¿œã‚’ã•ã›ãŸã„å ´åˆã¯ã©ã†ã™ã‚Œã°ã‚ˆã„ã®ã§ã—ã‚‡ã†ï¼Ÿ

ã“ã®ç« ã§ã¯ã€`2bykilt`ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã€Œç†Ÿç·´ã‚·ã‚§ãƒ•ã€ã¨ã‚‚è¨€ãˆã‚‹ **ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (`CustomAgent`)** ã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚

## ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (`CustomAgent`) ã¨ã¯ï¼Ÿ ãªãœå¿…è¦ï¼Ÿ

`browser-use`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¯ã€åŸºæœ¬çš„ãªã‚¦ã‚§ãƒ–æ“ä½œã‚’è¡Œã†ãŸã‚ã® `Agent` ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯è¨€ã‚ã°ã€ŒåŸºæœ¬ã®ãƒ¬ã‚·ãƒ”ã€ã‚’çŸ¥ã£ã¦ã„ã‚‹è¦‹ç¿’ã„ã‚·ã‚§ãƒ•ã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚ç°¡å˜ãªæŒ‡ç¤ºãªã‚‰ã“ãªã›ã¾ã™ãŒã€ã‚‚ã†å°‘ã—è¾¼ã¿å…¥ã£ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¯å¿œãˆã‚‰ã‚Œãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ä¾‹ãˆã°ã€ã‚ãªãŸãŒã€ŒAç¤¾ã®æœ€æ–°ã®æ ªä¾¡ã‚’èª¿ã¹ã¦ã€ã‚‚ã—å‰æ—¥æ¯”ã§5%ä»¥ä¸Šå¤‰å‹•ã—ã¦ã„ãŸã‚‰ã€é–¢é€£ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚‚3ã¤æ¢ã—ã¦ãã¦ã€ã¨ã„ã†ã‚¿ã‚¹ã‚¯ã‚’é ¼ã¿ãŸã„ã¨ã—ã¾ã™ã€‚ã“ã®ã‚¿ã‚¹ã‚¯ã«ã¯ã€å˜ã«æ ªä¾¡ã‚’èª¿ã¹ã‚‹ã ã‘ã§ãªãã€æ¡ä»¶ï¼ˆ5%ä»¥ä¸Šã®å¤‰å‹•ï¼‰ã«åŸºã¥ã„ã¦è¿½åŠ ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ‹ãƒ¥ãƒ¼ã‚¹æ¤œç´¢ï¼‰ã‚’è¡Œã†åˆ¤æ–­ãŒå¿…è¦ã§ã™ã€‚

ã“ã“ã§ç™»å ´ã™ã‚‹ã®ãŒ **ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (`CustomAgent`)** ã§ã™ã€‚ã“ã‚Œã¯`browser-use`ã®åŸºæœ¬`Agent`ã‚’**ç¶™æ‰¿**ã—ã€ã•ã‚‰ã«è³¢ãã€æŸ”è»Ÿã«å‹•ã‘ã‚‹ã‚ˆã†ã«æ©Ÿèƒ½æ‹¡å¼µã•ã‚ŒãŸã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚

`CustomAgent`ã¯ã€åŸºæœ¬ã®ãƒ¬ã‚·ãƒ”ï¼ˆ`Agent`ã®æ©Ÿèƒ½ï¼‰ã«åŠ ãˆã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªç‹¬è‡ªã®å·¥å¤«ã‚„éš ã—å‘³ã‚’æŒã£ã¦ã„ã¾ã™ã€‚

*   **è¿½åŠ æƒ…å ± (`add_infos`) ã®æ´»ç”¨:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ã€Œãƒ’ãƒ³ãƒˆã€ã‚„ã€Œè£œè¶³æƒ…å ±ã€ã‚’ç†è§£ã—ã€ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã«æ´»ã‹ã›ã¾ã™ã€‚ï¼ˆä¾‹ï¼šã€Œæ ªä¾¡ã¯ã€‡ã€‡è¨¼åˆ¸ã®ã‚µã‚¤ãƒˆã§èª¿ã¹ã¦ã€ã€Œãƒ‹ãƒ¥ãƒ¼ã‚¹ã¯â–³â–³æ–°èã‹ã‚‰æ¢ã—ã¦ã€ï¼‰
*   **ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä½¿ç”¨:** ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ€è€ƒå›è·¯ã‚„å¿œç­”æ–¹æ³•ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸã€ŒæŒ‡ç¤ºæ›¸ã€ï¼ˆ`CustomSystemPrompt`, `CustomAgentMessagePrompt`ï¼‰ã‚’ä½¿ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚ˆã‚Šçš„ç¢ºãªåˆ¤æ–­ã‚„æƒ…å ±æ•´ç†ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
*   **ç‹¬è‡ªã®æ€è€ƒãƒ»å‡ºåŠ›å½¢å¼ (`CustomAgentOutput`):** ã‚¿ã‚¹ã‚¯ã®é€²æ—çŠ¶æ³ã€æ¬¡ã«ä½•ã‚’ã™ã¹ãã‹ã®è¨ˆç”»ã€é›†ã‚ãŸé‡è¦ãªæƒ…å ±ãªã©ã‚’ã€ã‚ˆã‚Šè©³ç´°ãªå½¢å¼ã§è€ƒãˆã€å‡ºåŠ›ã—ã¾ã™ã€‚
*   **å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—æƒ…å ±ã®ç®¡ç† (`CustomAgentStepInfo`):** å„ã‚¹ãƒ†ãƒƒãƒ—ã§ã®ã‚¿ã‚¹ã‚¯ã®é€²æ—ã€è¨˜æ†¶ã—ã¦ã„ã‚‹é‡è¦æƒ…å ±ï¼ˆãƒ¡ãƒ¢ãƒªï¼‰ã€ä»Šå¾Œã®è¨ˆç”»ãªã©ã‚’è¨˜éŒ²ãƒ»ç®¡ç†ã—ã€æ¬¡ã®åˆ¤æ–­ã«æ´»ã‹ã—ã¾ã™ã€‚

ã¾ã‚‹ã§ã€åŸºæœ¬ãƒ¬ã‚·ãƒ”ã«ç‹¬è‡ªã®çµŒé¨“ã¨å·¥å¤«ã‚’åŠ ãˆã¦ã€ãŠå®¢ã•ã‚“ã®ç´°ã‹ãªè¦æœ›ã«ã‚‚å¿œãˆã‚‰ã‚Œã‚‹**ç†Ÿç·´ã‚·ã‚§ãƒ•**ã®ã‚ˆã†ã§ã™ã­ã€‚`CustomAgent`ã‚’ä½¿ã†ã“ã¨ã§ã€ã‚ˆã‚Šè¤‡é›‘ãªæŒ‡ç¤ºã«ã‚‚å¯¾å¿œã—ã€æ°—ã®åˆ©ã„ãŸæŒ¯ã‚‹èˆã„ã‚’ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã™ã€‚

## `CustomAgent` ã®ä¸»è¦ãªæ©Ÿèƒ½

`CustomAgent` ãŒåŸºæœ¬ã® `Agent` ã¨æ¯”ã¹ã¦ã©ã®ã‚ˆã†ãªç‚¹ãŒå„ªã‚Œã¦ã„ã‚‹ã®ã‹ã€ã‚‚ã†å°‘ã—è©³ã—ãè¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

```mermaid
graph LR
    A[åŸºæœ¬ Agent] --> B(åŸºæœ¬çš„ãªãƒ–ãƒ©ã‚¦ã‚¶æ“ä½œ);
    A --> C(åŸºæœ¬çš„ãªLLMã¨ã®å¯¾è©±);

    D[CustomAgent] -- ç¶™æ‰¿ --> A;
    D -- æ©Ÿèƒ½æ‹¡å¼µ --> E(è¿½åŠ æƒ…å ± `add_infos` ã®å‡¦ç†);
    D -- æ©Ÿèƒ½æ‹¡å¼µ --> F(ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ `CustomSystemPrompt`, `CustomAgentMessagePrompt`);
    D -- æ©Ÿèƒ½æ‹¡å¼µ --> G(ç‹¬è‡ªã®æ€è€ƒãƒ»å‡ºåŠ›å½¢å¼ `CustomAgentOutput`);
    D -- æ©Ÿèƒ½æ‹¡å¼µ --> H(å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—æƒ…å ± `CustomAgentStepInfo` ç®¡ç†);

    subgraph CustomAgentã®æ©Ÿèƒ½æ‹¡å¼µ
        E
        F
        G
        H
    end
```

*   **è¿½åŠ æƒ…å ± (`add_infos`) ã®å‡¦ç†:**
    Gradio UIã®ã€Œè¿½åŠ æƒ…å ± (Additional Information)ã€ã«å…¥åŠ›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã¯ã€`CustomAgent` ã« `add_infos` ã¨ã—ã¦æ¸¡ã•ã‚Œã¾ã™ã€‚`CustomAgent` ã¯ã“ã®æƒ…å ±ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆLLMã¸ã®æŒ‡ç¤ºæ›¸ï¼‰ã«å«ã‚ã‚‹ã“ã¨ã§ã€ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã®éš›ã®é‡è¦ãªãƒ’ãƒ³ãƒˆã¨ã—ã¦åˆ©ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã€Œã€‡ã€‡ã‚’å„ªå…ˆã—ã¦ã€ã€Œâ–³â–³ã¯é™¤å¤–ã—ã¦ã€ã¨ã„ã£ãŸç´°ã‹ãªãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã‚’æŒ‡ç¤ºã«åæ˜ ã§ãã¾ã™ã€‚

*   **ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ (`CustomSystemPrompt`, `CustomAgentMessagePrompt`):**
    ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒLLMï¼ˆå¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼‰ã«ã€Œä½•ã‚’è€ƒãˆã¦ã€ã©ã†å‹•ãã¹ãã‹ã€ã‚’æŒ‡ç¤ºã™ã‚‹ãŸã‚ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã™ã€‚
    *   `CustomSystemPrompt`: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå…¨ä½“ã®åŸºæœ¬çš„ãªå½¹å‰²ã€å®ˆã‚‹ã¹ããƒ«ãƒ¼ãƒ«ã€å‡ºåŠ›å½¢å¼ãªã©ã‚’å®šç¾©ã—ã¾ã™ã€‚`CustomAgent` ç”¨ã«èª¿æ•´ã•ã‚Œã¦ãŠã‚Šã€ã‚ˆã‚Šè©³ç´°ãªæ€è€ƒï¼ˆã‚¿ã‚¹ã‚¯é€²æ—ã€ä»Šå¾Œã®è¨ˆç”»ãªã©ï¼‰ã‚’ä¿ƒã—ã¾ã™ã€‚
    *   `CustomAgentMessagePrompt`: å„ã‚¹ãƒ†ãƒƒãƒ—ã§ã€ç¾åœ¨ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®çŠ¶æ…‹ã€éå»ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®çµæœã€ãã—ã¦ `add_infos` ã‚„è“„ç©ã•ã‚ŒãŸãƒ¡ãƒ¢ãƒªãªã©ã® `CustomAgentStepInfo` ã‚’å«ã‚ã¦ã€LLMã«çŠ¶æ³ã‚’ä¼ãˆã‚‹ãŸã‚ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€LLMã¯ã‚ˆã‚Šå¤šãã®æ–‡è„ˆã‚’è€ƒæ…®ã—ã¦æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ±ºå®šã§ãã¾ã™ã€‚
    ã“ã‚Œã‚‰ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®è©³ç´°ã¯ã€æ¬¡ã®ç«  [LLMé€£æºã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ](03_llmé€£æºã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ_.md) ã§è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚

*   **ç‹¬è‡ªã®æ€è€ƒãƒ»å‡ºåŠ›å½¢å¼ (`CustomAgentOutput`):**
    LLMãŒè€ƒãˆãŸçµæœï¼ˆæ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ï¼‰ã¨ã€æ¬¡ã«è¡Œã†ã¹ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæŒ‡ç¤ºï¼‰ã¯ã€ç‰¹å®šã®JSONå½¢å¼ã§å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚`CustomAgent` ã§ã¯ã€ã“ã®å‡ºåŠ›å½¢å¼ `CustomAgentOutput` ãŒæ‹¡å¼µã•ã‚Œã¦ãŠã‚Šã€åŸºæœ¬çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³æŒ‡ç¤ºã«åŠ ãˆã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã€Œæ€è€ƒã®ä¸­èº«ã€ã‚‚å«ã¾ã‚Œã¾ã™ã€‚
    *   `prev_action_evaluation`: å‰ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒæˆåŠŸã—ãŸã‹ã©ã†ã‹ã®è©•ä¾¡ã€‚
    *   `important_contents`: ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã§è¦‹ã¤ã‘ãŸé‡è¦ãªæƒ…å ±ã€‚
    *   `task_progress`: ã“ã‚Œã¾ã§ã«å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯ã®é …ç›®ã€‚
    *   `future_plans`: æ¬¡ã«å®Ÿè¡Œã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹è¨ˆç”»ã€‚
    *   `thought`: æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«è‡³ã‚‹ã¾ã§ã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã€‚
    *   `summary`: æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç°¡å˜ãªè¦ç´„ã€‚
    ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã€Œä»Šä½•ã‚’è€ƒãˆã¦ã„ã‚‹ã®ã‹ã€ã€Œã©ã“ã¾ã§é€²ã‚“ã§ã„ã‚‹ã®ã‹ã€ã‚’ã‚ˆã‚Šè©³ã—ãçŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã‚‰ã®æƒ…å ±ã¯Gradio UIã®ã€Œçµæœã€ã‚¿ãƒ–ã«ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

*   **å®Ÿè¡Œã‚¹ãƒ†ãƒƒãƒ—æƒ…å ±ã®ç®¡ç† (`CustomAgentStepInfo`):**
    ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã‚¿ã‚¹ã‚¯ã‚’ä¸€åº¦ã«å®Œäº†ã•ã›ã‚‹ã®ã§ã¯ãªãã€ä¸€é€£ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæ€è€ƒâ†’ã‚¢ã‚¯ã‚·ãƒ§ãƒ³â†’çŠ¶æ…‹ç¢ºèªâ†’æ€è€ƒ...ï¼‰ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚`CustomAgentStepInfo` ã¯ã€ã“ã‚Œã‚‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’é€šã˜ã¦å¤‰åŒ–ã—ã¦ã„ãæƒ…å ±ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®å…¥ã‚Œç‰©ã§ã™ã€‚
    *   `step_number`: ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—æ•°ã€‚
    *   `max_steps`: æœ€å¤§ã‚¹ãƒ†ãƒƒãƒ—æ•°ã€‚
    *   `task`: å®Ÿè¡Œä¸­ã®ã‚¿ã‚¹ã‚¯ã€‚
    *   `add_infos`: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®è¿½åŠ æƒ…å ±ã€‚
    *   `memory`: ã“ã‚Œã¾ã§ã«è¦‹ã¤ã‘ãŸé‡è¦ãªæƒ…å ±ã®è“„ç©ã€‚
    *   `task_progress`: ç¾åœ¨ã®ã‚¿ã‚¹ã‚¯é€²æ—ï¼ˆ`CustomAgentOutput`ã‹ã‚‰æ›´æ–°ï¼‰ã€‚
    *   `future_plans`: ä»Šå¾Œã®è¨ˆç”»ï¼ˆ`CustomAgentOutput`ã‹ã‚‰æ›´æ–°ï¼‰ã€‚
    `CustomAgent` ã¯å„ã‚¹ãƒ†ãƒƒãƒ—ã®çµ‚ã‚ã‚Šã« `CustomAgentOutput` ã®æ€è€ƒçµæœã‚’ä½¿ã£ã¦ã“ã® `CustomAgentStepInfo` ã‚’æ›´æ–°ã—ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆï¼ˆç‰¹ã« `CustomAgentMessagePrompt`ï¼‰ã«åˆ©ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯éå»ã®è¡Œå‹•ã‚„åé›†ã—ãŸæƒ…å ±ã‚’è¸ã¾ãˆãŸä¸Šã§ã€ã‚ˆã‚Šè³¢æ˜ãªåˆ¤æ–­ã‚’ä¸‹ã›ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## `CustomAgent` ã‚’ä½¿ã£ã¦ã¿ã‚ˆã†

ã§ã¯ã€å®Ÿéš›ã« `CustomAgent` ã‚’ä½¿ã£ã¦ã€å°‘ã—è¤‡é›‘ãªã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

1.  **Gradio UIã®èµ·å‹•:** (å‰ç« å‚ç…§)
    ```bash
    python bykilt.py
    ```
2.  **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®é¸æŠ:**
    UIã®ã€Œâš™ï¸ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆè¨­å®š (Agent Settings)ã€ã‚¿ãƒ–ã§ã€ã€Œã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚¿ã‚¤ãƒ— (Agent Type)ã€ãŒ `custom` ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ `custom` ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ï¼‰
3.  **ã‚¿ã‚¹ã‚¯ã¨è¿½åŠ æƒ…å ±ã®å…¥åŠ›:**
    ã€ŒğŸ¤– ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œ (Run Agent)ã€ã‚¿ãƒ–ã«ç§»å‹•ã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å…¥åŠ›ã—ã¾ã™ã€‚
    *   **ã‚¿ã‚¹ã‚¯èª¬æ˜ (Task Description):**
        `æ±äº¬ã§é–‹å‚¬ã•ã‚Œã‚‹AIé–¢é€£ã®ã‚«ãƒ³ãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’æ¤œç´¢ã—ã¦ã€ç›´è¿‘ã®ã‚‚ã®ã‚’3ã¤æ•™ãˆã¦`
    *   **è¿½åŠ æƒ…å ± (Additional Information):**
        `æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã¯Googleã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚connpassã‚„TECH PLAYãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆå‘ŠçŸ¥ã‚µã‚¤ãƒˆã‚’å„ªå…ˆçš„ã«è¦‹ã¦ãã ã•ã„ã€‚å‚åŠ è²»ç„¡æ–™ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Œã°ã€ãã‚Œã‚’æœ€åˆã«ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚`
4.  **å®Ÿè¡Œ:**
    ã€Œâ–¶ï¸ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œ (Run Agent)ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚
5.  **çµæœã®ç¢ºèª:**
    ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®Ÿè¡ŒãŒå®Œäº†ã—ãŸã‚‰ã€ã€ŒğŸ“Š çµæœ (Results)ã€ã‚¿ãƒ–ã‚’ç¢ºèªã—ã¾ã™ã€‚
    *   **æœ€çµ‚çµæœ (Final Result):** æŒ‡ç¤ºé€šã‚Šã«æ¤œç´¢ã•ã‚ŒãŸã‚«ãƒ³ãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚
    *   **æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ (Model Thoughts):** `CustomAgentOutput` ã® `thought`, `task_progress`, `future_plans` ãªã©ã«åŸºã¥ã„ãŸã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ€è€ƒéç¨‹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ãŒè¦‹ã‚‰ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
        ```
        æ€è€ƒ:
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ±äº¬ã®AIã‚«ãƒ³ãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã‚’æ¢ã—ã¦ãŠã‚Šã€Googleæ¤œç´¢ã€ç‰¹å®šã®ã‚¤ãƒ™ãƒ³ãƒˆã‚µã‚¤ãƒˆã€ç„¡æ–™ã‚¤ãƒ™ãƒ³ãƒˆã‚’å„ªå…ˆã™ã‚‹ã‚ˆã†ã«æŒ‡ç¤ºã•ã‚Œã¦ã„ã‚‹ã€‚ã¾ãšGoogleã§æ¤œç´¢ã—ã€connpassã‚„TECH PLAYã®ã‚µã‚¤ãƒˆã¸ã®ãƒªãƒ³ã‚¯ã‚’æ¢ãã†ã€‚è¦‹ã¤ã‹ã£ãŸã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’æ•´ç†ã—ã€ç„¡æ–™ã®ã‚‚ã®ã‚’å„ªå…ˆã—ã¦ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

        ã‚¿ã‚¹ã‚¯é€²æ—:
        1. Googleæ¤œç´¢ã‚’å®Ÿè¡Œã—ãŸã€‚
        2. connpassã§é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã„ãã¤ã‹è¦‹ã¤ã‘ãŸã€‚

        ä»Šå¾Œã®è¨ˆç”»:
        1. TECH PLAYã§ã‚‚æ¤œç´¢ã™ã‚‹ã€‚
        2. è¦‹ã¤ã‘ãŸã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’æ•´ç†ã—ã€å‚åŠ è²»ã‚’ç¢ºèªã™ã‚‹ã€‚
        3. ç„¡æ–™ã‚¤ãƒ™ãƒ³ãƒˆã‚’å„ªå…ˆã—ã¦ã€ç›´è¿‘ã®3ä»¶ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹ã€‚
        ```
    ã“ã®ã‚ˆã†ã«ã€`CustomAgent` ã¯ `add_infos` ã‚’è€ƒæ…®ã—ã€ã‚ˆã‚Šè©³ç´°ãªæ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã‚’çµŒã¦ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

## å†…éƒ¨ã®ä»•çµ„ã¿ï¼š`CustomAgent` ã¯ã©ã†å‹•ãï¼Ÿ

`CustomAgent` ãŒã©ã®ã‚ˆã†ã«ã—ã¦ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’å®Ÿç¾ã—ã¦ã„ã‚‹ã®ã‹ã€å†…éƒ¨ã®å‹•ãã‚’è¦—ã„ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

### å‡¦ç†ã®æµã‚Œï¼ˆã‚¹ãƒ†ãƒƒãƒ—ãƒ»ãƒã‚¤ãƒ»ã‚¹ãƒ†ãƒƒãƒ—ï¼‰

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¿ã‚¹ã‚¯ã¨è¿½åŠ æƒ…å ±ã‚’å…¥åŠ›ã—ã¦å®Ÿè¡Œã™ã‚‹ã¨ã€`CustomAgent` ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¹ãƒ†ãƒƒãƒ—ã§å‹•ä½œã—ã¾ã™ã€‚

1.  **åˆæœŸåŒ–:** ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (`bykilt.py`) ã¯ã€UIã‹ã‚‰å—ã‘å–ã£ãŸã‚¿ã‚¹ã‚¯èª¬æ˜ã¨è¿½åŠ æƒ…å ± (`add_infos`) ã‚’ä½¿ã£ã¦ `CustomAgent` ã‚’æº–å‚™ã—ã¾ã™ã€‚ã“ã®ã¨ãã€`CustomAgentStepInfo` ã‚‚åˆæœŸåŒ–ã•ã‚Œã¾ã™ï¼ˆã‚¿ã‚¹ã‚¯ã€è¿½åŠ æƒ…å ±ãªã©ãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹ï¼‰ã€‚
2.  **å®Ÿè¡Œãƒ«ãƒ¼ãƒ—é–‹å§‹:** `CustomAgent` ã® `run` ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã°ã‚Œã€æœ€å¤§ã‚¹ãƒ†ãƒƒãƒ—æ•°ã«é”ã™ã‚‹ã‹ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã™ã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—å‡¦ç†ãŒå§‹ã¾ã‚Šã¾ã™ã€‚
3.  **ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ (`step` ãƒ¡ã‚½ãƒƒãƒ‰):** ãƒ«ãƒ¼ãƒ—ã®å„ã‚¹ãƒ†ãƒƒãƒ—ã§ä»¥ä¸‹ã®å‡¦ç†ãŒè¡Œã‚ã‚Œã¾ã™ã€‚
    a.  **çŠ¶æ…‹å–å¾—:** ç¾åœ¨ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®URLã€è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹è¦ç´ ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãªã©ã®çŠ¶æ…‹ã‚’å–å¾—ã—ã¾ã™ ([ãƒ–ãƒ©ã‚¦ã‚¶åˆ¶å¾¡ã¨ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³](04_ãƒ–ãƒ©ã‚¦ã‚¶åˆ¶å¾¡ã¨ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³_.md)é–¢é€£)ã€‚
    b.  **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ:** `CustomMessageManager` ãŒ `CustomAgentMessagePrompt` ã‚’ä½¿ã£ã¦ã€LLMã¸ã®æŒ‡ç¤ºæ›¸ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã¯ã€ç¾åœ¨ã®ãƒ–ãƒ©ã‚¦ã‚¶çŠ¶æ…‹ã€ç›´å‰ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³çµæœã€ãã—ã¦ `CustomAgentStepInfo`ï¼ˆã‚¿ã‚¹ã‚¯ã€`add_infos`ã€ç¾åœ¨ã®ãƒ¡ãƒ¢ãƒªã€é€²æ—ã€è¨ˆç”»ãªã©ï¼‰ã®å†…å®¹ãŒå«ã¾ã‚Œã¾ã™ã€‚
    c.  **LLMå‘¼ã³å‡ºã—:** ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ [LLM](03_llmé€£æºã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ_.md) ã«é€ä¿¡ã—ã¾ã™ã€‚
    d.  **æ€è€ƒã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å—ä¿¡:** LLMã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è§£é‡ˆã—ã€æ¬¡ã«å–ã‚‹ã¹ãã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒªã‚¹ãƒˆã¨ã€ãã®åˆ¤æ–­ã«è‡³ã£ãŸæ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ï¼ˆ`prev_action_evaluation`, `important_contents`, `task_progress`, `future_plans`, `thought`, `summary` ãªã©ï¼‰ã‚’ `CustomAgentOutput` ã®å½¢å¼ã§è¿”ã—ã¾ã™ã€‚
    e.  **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ:** `CustomAgent` ã¯ `CustomAgentOutput` ã‹ã‚‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒªã‚¹ãƒˆã‚’å–ã‚Šå‡ºã—ã€[ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼](04_ãƒ–ãƒ©ã‚¦ã‚¶åˆ¶å¾¡ã¨ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³_.md) ã‚’é€šã˜ã¦ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å®Ÿè¡Œã—ã¾ã™ï¼ˆä¾‹: è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã€ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãªã©ï¼‰ã€‚
    f.  **ã‚¹ãƒ†ãƒƒãƒ—æƒ…å ±æ›´æ–°:** `CustomAgentOutput` ã«å«ã¾ã‚Œã‚‹æ€è€ƒçµæœï¼ˆ`important_contents`, `task_progress`, `future_plans` ãªã©ï¼‰ã‚’ä½¿ã£ã¦ã€`CustomAgentStepInfo` ã®ãƒ¡ãƒ¢ãƒªã€é€²æ—ã€è¨ˆç”»ãªã©ã‚’æ›´æ–°ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆæ™‚ã«æœ€æ–°ã®æƒ…å ±ãŒåæ˜ ã•ã‚Œã¾ã™ã€‚
    g.  **å®Œäº†åˆ¤å®š:** `CustomAgentOutput` ã«å«ã¾ã‚Œã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã€Œå®Œäº† (`Done`)ã€ã‚’ç¤ºã™ã‚‚ã®ã§ã‚ã‚Œã°ã€ãƒ«ãƒ¼ãƒ—ã‚’çµ‚äº†ã—ã¾ã™ã€‚
4.  **çµæœè¿”å´:** ãƒ«ãƒ¼ãƒ—ãŒçµ‚äº†ã—ãŸã‚‰ã€æœ€çµ‚çš„ãªçµæœï¼ˆåé›†ã—ãŸæƒ…å ±ã‚„ã‚¨ãƒ©ãƒ¼ãªã©ï¼‰ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµŒç”±ã§Gradio UIã«è¿”ã—ã¾ã™ã€‚

ã“ã‚Œã‚’ç°¡å˜ãªã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã§è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```mermaid
sequenceDiagram
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant GradioUI as Gradio UI
    participant Backend as ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
    participant CustomAgent as ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
    participant LLM as å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«

    User->>GradioUI: ã‚¿ã‚¹ã‚¯ã¨è¿½åŠ æƒ…å ±å…¥åŠ›ã€å®Ÿè¡Œ
    GradioUI->>Backend: å®Ÿè¡ŒæŒ‡ç¤º (ã‚¿ã‚¹ã‚¯, è¿½åŠ æƒ…å ±)
    Backend->>CustomAgent: åˆæœŸåŒ– (ã‚¿ã‚¹ã‚¯, è¿½åŠ æƒ…å ±, StepInfoåˆæœŸåŒ–)
    loop å„ã‚¹ãƒ†ãƒƒãƒ— (æœ€å¤§ã‚¹ãƒ†ãƒƒãƒ—æ•°ã¾ã§ or å®Œäº†ã¾ã§)
        CustomAgent->>CustomAgent: ãƒ–ãƒ©ã‚¦ã‚¶çŠ¶æ…‹å–å¾—
        CustomAgent->>CustomAgent: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ (çŠ¶æ…‹, StepInfo[è¿½åŠ æƒ…å ±, ãƒ¡ãƒ¢ãƒª, é€²æ—, è¨ˆç”»] ã‚’ä½¿ç”¨)
        CustomAgent->>LLM: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡
        LLM-->>CustomAgent: æ€è€ƒã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (CustomAgentOutput[é€²æ—, è¨ˆç”», ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆãªã©])
        CustomAgent->>CustomAgent: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ (ãƒ–ãƒ©ã‚¦ã‚¶åˆ¶å¾¡çµŒç”±)
        CustomAgent->>CustomAgent: StepInfoæ›´æ–° (Outputã®æ€è€ƒ[é€²æ—, è¨ˆç”»ãªã©]ã‚’åæ˜ )
        alt Doneã‚¢ã‚¯ã‚·ãƒ§ãƒ³å—ä¿¡
            CustomAgent-->>Backend: ãƒ«ãƒ¼ãƒ—çµ‚äº†ã€æœ€çµ‚çµæœ
            break
        end
    end
    Backend-->>GradioUI: çµæœè¡¨ç¤º
    GradioUI-->>User: çµæœç¢ºèª
```

### ã‚³ãƒ¼ãƒ‰ã§ã®å®Ÿè£…

å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ (`src/agent/custom_agent.py` ãªã©) ã§ã¯ã€ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ãŒã©ã®ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ã€ä¸»è¦ãªéƒ¨åˆ†ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

1.  **`CustomAgent` ã®åˆæœŸåŒ– (`__init__`)**
    ã“ã“ã§ã€ã‚¿ã‚¹ã‚¯ (`task`) ã‚„è¿½åŠ æƒ…å ± (`add_infos`) ã‚’å—ã‘å–ã‚Šã€ã‚«ã‚¹ã‚¿ãƒ ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç®¡ç†ã‚¯ãƒ©ã‚¹ `CustomMessageManager` ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™ã€‚

    ```python
    # --- File: src/agent/custom_agent.py ---
    class CustomAgent(Agent):
        def __init__(
                self,
                task: str,
                llm: BaseChatModel,
                add_infos: str = "", # è¿½åŠ æƒ…å ±ã‚’å—ã‘å–ã‚‹
                # ... ä»–ã®å¼•æ•° ...
                agent_prompt_class: Type[AgentMessagePrompt] = AgentMessagePrompt, # ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¯ãƒ©ã‚¹
                # ...
        ):
            super().__init__(...) # è¦ªã‚¯ãƒ©ã‚¹(Agent)ã®åˆæœŸåŒ–
            # ...
            self.add_infos = add_infos # è¿½åŠ æƒ…å ±ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ã«ä¿æŒ

            # ã‚«ã‚¹ã‚¿ãƒ ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’ä½¿ç”¨
            self.message_manager = CustomMessageManager(
                llm=self.llm,
                task=self.task,
                action_descriptions=self.controller.registry.get_prompt_description(),
                system_prompt_class=self.system_prompt_class, # SystemPromptã‚‚æŒ‡å®šå¯èƒ½
                agent_prompt_class=agent_prompt_class, # CustomAgentMessagePrompt ã‚’ä½¿ã†ã‚ˆã†ã«æŒ‡å®š
                # ... ä»–ã®è¨­å®š ...
            )
            # ...
            # CustomAgentOutput ã‚’ä½¿ã†ã‚ˆã†ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ¢ãƒ‡ãƒ«ã‚’è¨­å®š
            self._setup_action_models()
    ```
    *   `add_infos` ã‚’å¼•æ•°ã§å—ã‘å–ã‚Šã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ã«ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚
    *   `CustomMessageManager` ã‚’åˆæœŸåŒ–ã™ã‚‹éš›ã«ã€`agent_prompt_class` ã¨ã—ã¦ `CustomAgentMessagePrompt` (ã¾ãŸã¯ãã®äº’æ›ã‚¯ãƒ©ã‚¹) ã‚’æ¸¡ã™ã“ã¨ã§ã€ã‚«ã‚¹ã‚¿ãƒ ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ãŒä½¿ã‚ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
    *   `_setup_action_models` ã§ã€LLMã®å‡ºåŠ›å½¢å¼ã¨ã—ã¦ `CustomAgentOutput` ã‚’ä½¿ã†ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚

2.  **ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ (`step`) å†…ã§ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆã¨æƒ…å ±æ›´æ–°**
    `step` ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¸­ã§ã€`CustomAgentStepInfo` ã‚’ä½¿ã£ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆã—ã€LLMã‹ã‚‰ã®å¿œç­” (`CustomAgentOutput`) ã‚’ä½¿ã£ã¦ `CustomAgentStepInfo` ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™ã€‚

    ```python
    # --- File: src/agent/custom_agent.py ---
    class CustomAgent(Agent):
        # ... (initãªã©) ...

        async def step(self, step_info: Optional[CustomAgentStepInfo] = None) -> None:
            # ... (çŠ¶æ…‹å–å¾—ãªã©) ...
            try:
                state = await self.browser_context.get_state()
                # ...

                # CustomMessageManager ã‚’ä½¿ã£ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ(ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)ã‚’ç”Ÿæˆ
                # ã“ã“ã§ step_info (add_infos, memory, progress, plans ãªã©ã‚’å«ã‚€) ãŒä½¿ã‚ã‚Œã‚‹
                self.message_manager.add_state_message(state, self._last_actions, self._last_result, step_info, self.use_vision)
                input_messages = self.message_manager.get_messages()
                # ...

                # LLM ã‚’å‘¼ã³å‡ºã—ã¦æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨æ€è€ƒ (CustomAgentOutput) ã‚’å–å¾—
                model_output: CustomAgentOutput = await self.get_next_action(input_messages) # å‹ãƒ’ãƒ³ãƒˆãŒ CustomAgentOutput ã«ãªã£ã¦ã„ã‚‹ç‚¹ã«æ³¨æ„
                # ...

                # LLMã®æ€è€ƒçµæœã‚’ä½¿ã£ã¦ step_info ã‚’æ›´æ–°
                self.update_step_info(model_output, step_info)
                # ...

                # model_output ã‹ã‚‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¦å®Ÿè¡Œ
                actions: list[ActionModel] = model_output.action
                result: list[ActionResult] = await self.controller.multi_act(...)
                # ... (çµæœå‡¦ç†ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãªã©) ...

            except Exception as e:
                # ... (ã‚¨ãƒ©ãƒ¼å‡¦ç†) ...
            finally:
                # ... (å¾Œå‡¦ç†) ...

        def update_step_info(
                self, model_output: CustomAgentOutput, step_info: CustomAgentStepInfo = None
        ):
            # model_output ã®æ€è€ƒçµæœ (important_contents, task_progress, future_plans) ã‚’
            # step_info ã® memory, task_progress, future_plans ã«åæ˜ ã™ã‚‹
            if step_info is None:
                return
            step_info.step_number += 1
            important_contents = model_output.current_state.important_contents
            if (...): # æ¡ä»¶ãƒã‚§ãƒƒã‚¯
                step_info.memory += important_contents + "\n" # ãƒ¡ãƒ¢ãƒªã«è¿½åŠ 
            task_progress = model_output.current_state.task_progress
            if (...): # æ¡ä»¶ãƒã‚§ãƒƒã‚¯
                step_info.task_progress = task_progress # é€²æ—ã‚’æ›´æ–°
            future_plans = model_output.current_state.future_plans
            if (...): # æ¡ä»¶ãƒã‚§ãƒƒã‚¯
                step_info.future_plans = future_plans # è¨ˆç”»ã‚’æ›´æ–°
            # ...
    ```
    *   `message_manager.add_state_message` ã« `step_info` ã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆæ™‚ã« `add_infos` ã‚„ç¾åœ¨ã®ãƒ¡ãƒ¢ãƒªã€é€²æ—ã€è¨ˆç”»ãŒè€ƒæ…®ã•ã‚Œã¾ã™ã€‚
    *   `get_next_action` ã‹ã‚‰è¿”ã£ã¦ãã‚‹å‹ãŒ `CustomAgentOutput` ã«ãªã£ã¦ãŠã‚Šã€æ€è€ƒæƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
    *   `update_step_info` ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€`model_output` (LLMã®æ€è€ƒçµæœ) ã‚’ä½¿ã£ã¦ `step_info` ã®å†…å®¹ï¼ˆãƒ¡ãƒ¢ãƒªã€é€²æ—ã€è¨ˆç”»ï¼‰ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™ã€‚

3.  **ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ç”Ÿæˆ (`CustomAgentMessagePrompt`)**
    `CustomMessageManager` ãŒå†…éƒ¨ã§ä½¿ã† `CustomAgentMessagePrompt` ã¯ã€`step_info` ã‚’å—ã‘å–ã‚Šã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆã«æƒ…å ±ã‚’åŸ‹ã‚è¾¼ã¿ã¾ã™ã€‚

    ```python
    # --- File: src/agent/custom_prompts.py ---
    class CustomAgentMessagePrompt(AgentMessagePrompt):
        def __init__(
                self,
                state: BrowserState,
                # ... ä»–ã®å¼•æ•° ...
                step_info: Optional[CustomAgentStepInfo] = None, # step_info ã‚’å—ã‘å–ã‚‹
        ):
            super().__init__(...)
            self.step_info = step_info # ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ã«ä¿æŒ

        def get_user_message(self, use_vision: bool = True) -> HumanMessage:
            if self.step_info:
                # step_info ã‹ã‚‰æƒ…å ±ã‚’å–ã‚Šå‡ºã—ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å«ã‚ã‚‹
                step_info_description = f'Current step: {self.step_info.step_number}/{self.step_info.max_steps}\n'
                # ... (ç¾åœ¨æ™‚åˆ»ãªã©ã‚‚è¿½åŠ ) ...
            else:
                step_info_description = ''
            # ...

            state_description = f"""
{step_info_description}
1. Task: {self.step_info.task}.
2. Hints(Optional):
{self.step_info.add_infos}  # ã“ã“ã§ add_infos ã‚’ä½¿ç”¨
3. Memory:
{self.step_info.memory}     # ã“ã“ã§ç¾åœ¨ã®ãƒ¡ãƒ¢ãƒªã‚’ä½¿ç”¨
4. Current url: {self.state.url}
5. Available tabs: ...
6. Interactive elements: ...
# (ã“ã“ã«ç¾åœ¨ã®ãƒ–ãƒ©ã‚¦ã‚¶è¦ç´ ãªã©ãŒç¶šã)
            """
            # ... (å‰ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³çµæœãªã©ã‚‚è¿½åŠ ) ...

            # ç”»åƒã‚’ä½¿ã†å ´åˆã¯ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å«ã‚ã‚‹
            if self.state.screenshot and use_vision == True:
                return HumanMessage(content=[{'type': 'text', 'text': state_description}, {'type': 'image_url', ...}])
            else:
                return HumanMessage(content=state_description)
    ```
    *   `__init__` ã§ `step_info` ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚
    *   `get_user_message` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ã€`self.step_info.task`, `self.step_info.add_infos`, `self.step_info.memory` ãªã©ã‚’å‚ç…§ã—ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆ (`state_description`) ã«çµ„ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚

4.  **ã‚«ã‚¹ã‚¿ãƒ å‡ºåŠ›å½¢å¼ã¨ã‚¹ãƒ†ãƒƒãƒ—æƒ…å ±ã®å®šç¾© (`CustomAgentOutput`, `CustomAgentStepInfo`)**
    ã“ã‚Œã‚‰ã®ã‚¯ãƒ©ã‚¹ã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚„ã‚Šå–ã‚Šã™ã‚‹æƒ…å ±ã®æ§‹é€ ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

    ```python
    # --- File: src/agent/custom_views.py ---
    from pydantic import BaseModel, Field
    from dataclasses import dataclass
    # ...

    @dataclass # ãƒ‡ãƒ¼ã‚¿ä¿æŒç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ãƒ©ã‚¹
    class CustomAgentStepInfo:
        step_number: int
        max_steps: int
        task: str
        add_infos: str # è¿½åŠ æƒ…å ±
        memory: str    # è“„ç©ã•ã‚ŒãŸé‡è¦æƒ…å ±
        task_progress: str # ã‚¿ã‚¹ã‚¯é€²æ—
        future_plans: str  # ä»Šå¾Œã®è¨ˆç”»

    class CustomAgentBrain(BaseModel): # LLMã®æ€è€ƒéƒ¨åˆ†ã®æ§‹é€ 
        prev_action_evaluation: str
        important_contents: str
        task_progress: str
        future_plans: str
        thought: str
        summary: str

    class CustomAgentOutput(AgentOutput): # LLMã‹ã‚‰ã®å‡ºåŠ›å…¨ä½“ã®æ§‹é€ 
        # ...
        current_state: CustomAgentBrain # ä¸Šã§å®šç¾©ã—ãŸæ€è€ƒéƒ¨åˆ†ã‚’å«ã‚€
        action: list[ActionModel] # æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆ
        # ...
    ```
    *   `CustomAgentStepInfo`: ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚¹ãƒ†ãƒƒãƒ—é–“ã§å¼•ãç¶™ãæƒ…å ±ã‚’å®šç¾©ã—ã¾ã™ (`add_infos`, `memory`, `task_progress`, `future_plans` ãªã©)ã€‚
    *   `CustomAgentBrain`: LLMãŒå‡ºåŠ›ã™ã‚‹æ€è€ƒå†…å®¹ã®æ§‹é€ ã‚’å®šç¾©ã—ã¾ã™ã€‚
    *   `CustomAgentOutput`: LLMã‹ã‚‰ã®å¿œç­”å…¨ä½“ã®æ§‹é€ ã‚’å®šç¾©ã—ã€`CustomAgentBrain` (æ€è€ƒ) ã¨ `action` (ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æŒ‡ç¤º) ã‚’å«ã¿ã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã€`CustomAgent` ã¯åŸºæœ¬ã® `Agent` ã‚’æ‹¡å¼µã—ã€`add_infos`ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€è©³ç´°ãªæ€è€ƒå‡ºåŠ› (`CustomAgentOutput`)ã€ã‚¹ãƒ†ãƒƒãƒ—é–“ã®æƒ…å ±ç®¡ç† (`CustomAgentStepInfo`) ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šé«˜åº¦ã§æŸ”è»Ÿãªã‚¿ã‚¹ã‚¯å®Ÿè¡Œã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

## ã¾ã¨ã‚

ã“ã®ç« ã§ã¯ã€`2bykilt` ã®è³¢ã„å®Ÿè¡Œå½¹ã§ã‚ã‚‹ **ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ (`CustomAgent`)** ã«ã¤ã„ã¦å­¦ã³ã¾ã—ãŸã€‚`CustomAgent` ãŒåŸºæœ¬ã® `Agent` ã‚’ã©ã®ã‚ˆã†ã«æ‹¡å¼µã—ã€è¿½åŠ æƒ…å ± (`add_infos`) ã‚„ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€ç‹¬è‡ªã®æ€è€ƒãƒ»å‡ºåŠ›å½¢å¼ (`CustomAgentOutput`)ã€ã‚¹ãƒ†ãƒƒãƒ—æƒ…å ±ç®¡ç† (`CustomAgentStepInfo`) ã‚’ä½¿ã£ã¦ã€ã‚ˆã‚Šè¤‡é›‘ã§ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã®ã‚ã‚‹æŒ‡ç¤ºã«å¯¾å¿œã§ãã‚‹ã€Œç†Ÿç·´ã‚·ã‚§ãƒ•ã€ã®ã‚ˆã†ãªå­˜åœ¨ã§ã‚ã‚‹ã“ã¨ã‚’ç†è§£ã—ã¾ã—ãŸã€‚

Gradio UI ã‚’ä½¿ã£ã¦ `CustomAgent` ã«è¿½åŠ æƒ…å ±ã‚’ä¸ãˆã‚‹æ–¹æ³•ã‚„ã€ãã®çµæœã¨ã—ã¦ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ãŒã©ã®ã‚ˆã†ã«å¤‰åŒ–ã™ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚ã¾ãŸã€å†…éƒ¨ã§ã“ã‚Œã‚‰ã®æƒ…å ±ãŒã©ã®ã‚ˆã†ã«å‡¦ç†ã•ã‚Œã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆã‚„ã‚¹ãƒ†ãƒƒãƒ—æ›´æ–°ã«åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ã®æ¦‚è¦ã‚‚æ´ã‚ã¾ã—ãŸã€‚

ã—ã‹ã—ã€`CustomAgent` ãŒè³¢ãæŒ¯ã‚‹èˆã†ãŸã‚ã«ã¯ã€ãã®ã€Œè„³ã€ã§ã‚ã‚‹å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ï¼ˆLLMï¼‰ã¨ã®é€£æºãŒä¸å¯æ¬ ã§ã™ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ã©ã®ã‚ˆã†ã«ã—ã¦LLMã«æŒ‡ç¤ºã‚’å‡ºã—ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆï¼‰ã€LLMã‹ã‚‰ã®å¿œç­”ï¼ˆæ€è€ƒã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ã‚’è§£é‡ˆã—ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

æ¬¡ã®ç« ã€[LLMé€£æºã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ](03_llmé€£æºã¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ_.md)ã§ã¯ã€ã“ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨LLMã®å¯¾è©±ã®æ ¸å¿ƒéƒ¨åˆ†ã«ã¤ã„ã¦ã€ã•ã‚‰ã«è©³ã—ãæ˜ã‚Šä¸‹ã’ã¦ã„ãã¾ã™ã€‚

---

Generated by [AI Codebase Knowledge Builder](https://github.com/The-Pocket/Tutorial-Codebase-Knowledge)